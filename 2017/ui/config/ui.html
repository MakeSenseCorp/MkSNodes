<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="description" content="">
        <meta name="author" content="">

        <title>YouTube Player</title>

        <link rel="stylesheet" href="/static/lib/bootstrap/css/bootstrap.min.css" crossorigin="anonymous">
     
        <style>
            body {
              font-size: .875rem;
            }
            .feather {
              width: 16px;
              height: 16px;
              vertical-align: text-bottom;
            }
            html {
              position: relative;
              min-height: 100%;
            }
            body {
              /* Margin bottom by footer height */
              margin-bottom: 60px;
            }
            .footer {
              position: absolute;
              bottom: 0;
              width: 100%;
              /* Set the fixed height of the footer here */
              height: 60px;
              line-height: 60px; /* Vertically center the text there */
              background-color: #f5f5f5;
            }
            body > .container {
              padding: 60px 15px 0;
            }
            .footer > .container {
              padding-right: 15px;
              padding-left: 15px;
            }
            code {
              font-size: 80%;
            }
        </style>

        <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
        <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
        <!--[if lt IE 9]>
          <script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
          <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
        <![endif]-->
    </head>
    <body>
        <main role="main" class="container">
        	<div class="row">
        	    <div class="col-lg-12">
        	        <div class="card">

                    <div class="card-body">
                      <h6 class="d-flex justify-content-between align-items-center mb-3">
                        <span class="text-muted">Cameras List (<a href="#" onclick="GetFrameFromAllCameras()">Refresh</a>)</span>
                        <span class="badge badge-secondary badge-pill" id="cameras_count_id">0</span>
                      </h6>
                      	<div id="cameras_list_id"></div>
                    </div>
                  </div>
        	    </div>
			</div>
			<!-- Modal -->
			<div class="modal fade" id="exampleModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
				<div class="modal-dialog" role="document">
					<div class="modal-content">
						<div class="modal-header">
							<h5 class="modal-title" id="exampleModalLabel">Modal title</h5>
							<button type="button" class="close" data-dismiss="modal" aria-label="Close">
							<span aria-hidden="true">&times;</span>
							</button>
						</div>
						<div class="modal-body">
							<div class="card">
								<div class="card-body">
									<h6 class="d-flex justify-content-between align-items-center mb-3">
										<span class="text-muted">Precentage till next video creation (<a href="#" onclick="">Refresh</a>)</span>
									</h6>
									<div class="progress">
										<div class="progress-bar" role="progressbar" style="width: 25%;" aria-valuenow="25" aria-valuemin="0" aria-valuemax="100">25%</div>
									</div>
								</div>
								<div class="card-body">
									<h6 class="d-flex justify-content-between align-items-center mb-3">
										<span class="text-muted">Face detection (Enable/Disable)</span>
									</h6>
									<div class="form-group form-check">
										<input type="checkbox" class="form-check-input" id="exampleCheck1">
										<label class="form-check-label" for="exampleCheck1">Check me out</label>
									</div>
								</div>
								<div class="card-body">
									<h6 class="d-flex justify-content-between align-items-center mb-3">
										<span class="text-muted">Camera sensetivity</span>
									</h6>
									<input type="range" class="custom-range" min="0" max="5" step="0.5" id="customRange3">
								</div>
								<div class="card-body">
									<h6 class="d-flex justify-content-between align-items-center mb-3">
										<span class="text-muted">Frames Per Video</span>
									</h6>
									<input type="range" class="custom-range" min="0" max="5" step="0.5" id="customRange3">
								</div>
								<div class="card-body">
									<h6 class="d-flex justify-content-between align-items-center mb-3">
										<span class="text-muted">Vidoe Files <a href="#" onclick="GetFileList();">Refresh</a></span>
										<span class="badge badge-secondary badge-pill" id="files_count_id">0</span>
									</h6>
									<div id="files_list_id"></div>
								</div>
							</div>
						</div>
						<div class="modal-footer">
							<button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
							<button type="button" class="btn btn-primary">Save changes</button>
						</div>
					</div>
				</div>
			</div>
        </main>

        <script src="/static/lib/nodes/js/jquery_3_3_1/jquery.min.js"></script>
        <script src="/static/lib/nodes/js/popper_1_14_7/popper.min.js" crossorigin="anonymous"></script>
        <script src="/static/lib/bootstrap/js/bootstrap.min.js" crossorigin="anonymous"></script>
        <script src="/static/lib/nodes/js/feather_4_19/feather.min.js"></script>
        <script src="/static/lib/nodes/map/feather_4_19/feather.min.js.map"></script>
        
        <script src="mksdk-js/MkSAPI.js"></script>
        <script src="mksdk-js/MkSCommon.js"></script>
        <script src="mksdk-js/MkSGateway.js"></script>
        <script src="mksdk-js/MkSWebface.js"></script>

        <script>
          	var NodeUUID = "ac6de837-9863-72a9-c789-a0aae7e9d021";

			// Gey makesense api instanse.
			var api = MkSAPIBuilder.GetInstance();

			var CameraCell = `
						<div class="col-lg-6">
		                    <div class="card">
								<div class="card-body">
									<h6 class="d-flex justify-content-between align-items-center mb-3">
										<span class="text-muted">[NAME]</span>
									</h6>
									<div class="row">
										<!-- <div class="col-lg-12">
											<img width="100%" src="http://[IPADDRESS]/tmpfs/auto.jpg?t=" onload="setTimeout(function(){src=src.substring(0, (src.lastIndexOf('t=')+2))+(new Date()).getTime()}, 1000)"/>
										</div> -->
										<div class="col-lg-12">
											<img width="100%" class="rounded" src="http://[IPADDRESS]/tmpfs/auto.jpg?t=" id="id_[IPADDRESS]" onLoad="update('[IPADDRESS]');"/>
										</div>
				  					</div><br>
									<div class="row">
										<div class="col-lg-3">
											<center><span onClick="Recording(this,'[CAMERA_MAC]','[CAMERA_UID]','[IPADDRESS]');" style="width: 16px; height: 16px; cursor: pointer;color: red" data-feather="circle"></span></center>
										</div>
										<div class="col-lg-3">
											<center><span onClick="Motion(this,'[CAMERA_MAC]','[CAMERA_UID]','[IPADDRESS]');" style="width: 16px; height: 16px; cursor: pointer;color: black" data-feather="users"></span></center>
										</div>
										<div class="col-lg-3">
											<center><span onClick="Security(this,'[CAMERA_MAC]','[CAMERA_UID]','[IPADDRESS]');" style="width: 16px; height: 16px; cursor: pointer;color: black" data-feather="shield"></span></center>
										</div>
										<div class="col-lg-3">
											<center><span onClick="OpenModal(this,'[CAMERA_MAC]','[CAMERA_UID]','[IPADDRESS]');" style="width: 16px; height: 16px; cursor: pointer;color: green" data-feather="settings"></span></center>
										</div>
									</div>
								</div>
							</div>
						</div>
		  	`;
		  	var img = new Image();
			var imgObj;

			var takeError = function () {
				img.src = "http://" + ip + "/tmpfs/auto.jpg?" + (new Date()).getTime();
			}

		  	var update = function (ip) {
				imgObj = document.getElementById("id_" + ip);
				
				if (imgObj !== null) {
					imgObj.src = img.src;
					img.src = "http://" + ip + "/tmpfs/auto.jpg?" + (new Date()).getTime();
					img.onerror = takeError;
					img.onload = update;
			  	}
			}
			
			api.ConnectGateway(function() {
				console.log("Connection to Gateway was established.");

				api.GetNodeSensorsInfo(NodeUUID, function(res){
					cameras = res.data.payload;
					var html = "";
					var cameraCount = cameras.length;
					console.log(cameras);
					for (i = 0; i < cameraCount; i++) {
						camera = cameras[i];
						if (i % 2) {
							html += `<div class="row">`;
						}

						row = CameraCell;
				        row = row.split("[NAME]").join(camera.name);
				        row = row.split("[IPADDRESS]").join(camera.ip);
						row = row.split("[CAMERA_MAC]").join(camera.mac);
						row = row.split("[CAMERA_UID]").join(camera.uid);
				        html += row;

						if (i % 2 != 0) {
							html += `</div>`;
						}

						img.src = "http://" + camera.ip + "/tmpfs/auto.jpg?" + new Date;
					}

					document.getElementById("cameras_count_id").innerHTML = cameraCount;
					document.getElementById("cameras_list_id").innerHTML = html;
              		feather.replace();
				});
			});

			function RecordingProgress (camer_ip, camera_mac, camera_uid) {
				self = this;

				this.CameraIP  	= camer_ip;
				this.CameraMAC 	= camera_mac;
				this.CameraUID 	= camera_uid;
				this.Handle		= 0;

				this.PublishProgress = function() {
					api.SendCustomCommand(NodeUUID, "get_capture_progress", {
						mac: self.CameraIP,
						uid: self.CameraMAC,
						ip: self.CameraUID
					}, function(res) {
						console.log(res);
					});
				}

				this.SetIntervalHndl = function(hndl) {
					this.Handle = hndl;
				}
			}

			var CurrentCamera = null;

			$('#exampleModal').on('hide.bs.modal', function (e) {
				clearInterval(CurrentCamera.Handle);
			})

			var OpenModal = function (elem, camera_mac, camera_uid, camer_ip) {
				$('#exampleModal').modal('show')
				CurrentCamera = new RecordingProgress(camer_ip, camera_mac, camera_uid);
				progressbarInterval = setInterval(CurrentCamera.PublishProgress, 1000);
				CurrentCamera.SetIntervalHndl(progressbarInterval);
			}

			var Recording = function(elem, camera_mac, camera_uid, camer_ip) {
				var action = (elem.style.color == 'red') ? false:true;

				if (action) {
					api.SendCustomCommand(NodeUUID, "start_recording", {
						mac: camera_mac,
						uid: camera_uid,
						ip: camer_ip
					}, function(res) {
						console.log(res);
						elem.style.color = "red";
					});
				} else {
					api.SendCustomCommand(NodeUUID, "stop_recording", {
						mac: camera_mac,
						uid: camera_uid,
						ip: camer_ip
					}, function(res) {
						console.log(res);
						elem.style.color = "green";
					});
				}
			}

			var Motion = function(elem, camera_mac, camera_uid, camer_ip) {
				var action = (elem.style.color == 'black') ? true:false;

				if (action) {
					api.SendCustomCommand(NodeUUID, "start_motion_detection", {
						mac: camera_mac,
						uid: camera_uid,
						ip: camer_ip
					}, function(res) {
						console.log(res);
						elem.style.color = "red";
					});
				} else {
					api.SendCustomCommand(NodeUUID, "stop_motion_detection", {
						mac: camera_mac,
						uid: camera_uid,
						ip: camer_ip
					}, function(res) {
						console.log(res);
						elem.style.color = "black";
					});
				}
			}

			var Security = function(elem, camera_mac, camera_uid, camer_ip) {
				var action = (elem.style.color == 'black') ? true:false;

				if (action) {
					api.SendCustomCommand(NodeUUID, "start_security", {
						mac: camera_mac,
						uid: camera_uid,
						ip: camer_ip
					}, function(res) {
						console.log(res);
						elem.style.color = "red";
					});
				} else {
					api.SendCustomCommand(NodeUUID, "stop_security", {
						mac: camera_mac,
						uid: camera_uid,
						ip: camer_ip
					}, function(res) {
						console.log(res);
						elem.style.color = "black";
					});
				}
			}

			feather.replace();
        </script>
    </body>
</html>
