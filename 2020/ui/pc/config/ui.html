<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="description" content="">
        <meta name="author" content="">

        <title>USB Cameras</title>

		[CSS]
     
        <style>
            body {
              font-size: .875rem;
            }
            .feather {
              width: 16px;
              height: 16px;
              vertical-align: text-bottom;
            }
            html {
              position: relative;
              min-height: 100%;
            }
            body {
              /* Margin bottom by footer height */
              margin-bottom: 60px;
            }
            .footer {
              position: absolute;
              bottom: 0;
              width: 100%;
              /* Set the fixed height of the footer here */
              height: 60px;
              line-height: 60px; /* Vertically center the text there */
              background-color: #f5f5f5;
            }
            body > .container {
              padding: 60px 15px 0;
            }
            .footer > .container {
              padding-right: 15px;
              padding-left: 15px;
            }
            code {
              font-size: 80%;
            }
        </style>

        <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
        <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
        <!--[if lt IE 9]>
          <script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
          <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
        <![endif]-->
    </head>
	<body>
		<main role="main" class="container">
			<div class="row">
				<div class="col-lg-6" id="id_tx_device"></div>
				<div class="col-lg-6" id="id_rx_device"></div>
			</div>
        	<div class="row">
        	    <div class="col-lg-12">
        	        <div class="card">
						<div class="card-body">
							<br>
							<h6 class="d-flex justify-content-between align-items-center mb-3">
								<span class="text-muted">Configurable Sensors</span>
								<span class="badge badge-secondary badge-pill" id="devices_count_id">0</span>
							</h6>
							<div id="devices_list_id"></div>
							<br>
							<h6 class="d-flex justify-content-between align-items-center mb-3">
								<span class="text-muted">Sensors</span>
								<span class="badge badge-secondary badge-pill" id="sensors_count_id">0</span>
							</h6>
							<div id="sensors_list_id"></div>
						</div>
                  	</div>
        	    </div>
			</div>
        </main>
		
		<!-- Modal -->
		<div class="modal fade bd-example-modal-xl" id="id-semsor-modal" tabindex="-1" role="dialog" aria-labelledby="id-semsor-modalLabel" aria-hidden="true">
			<div class="modal-dialog" role="document">
				<div class="modal-content">
					<div class="modal-header">
						<h5 class="modal-title" id="id-semsor-modalLabel">Settings</h5>
						<button type="button" class="close" data-dismiss="modal" aria-label="Close">
						<span aria-hidden="true">&times;</span>
						</button>
					</div>
					<div id="id_modal_content" class="modal-body"> </div>
					<div id="id_modal_footer" class="modal-footer"></div>
				</div>
			</div>
		</div>

		[SCRIPTS]

        <script>
          	var GatewayIP = "[GATEWAY_IP]";
			var NodeUUID  = "[NODE_UUID]";

			var rxState = 0;
			var txState = 0;
			console.log("Node 1981 JS loaded ...");

			function DOMTableContainer(name) {
				this.Name = name;

				this.DOMTable = `
								<div class='table-responsive'>
									<table class='table table-striped table-sm'>
										<thead>[HEAD]</thead>
										<tbody id="idMakeSense` + this.Name + `">[BODY]</tbody>
									</table>
								</div>
								`;
				this.HTML = "";
				this.HEAD = "";
				this.BODY = "";

				this.CreateHead = function(items) {
					this.HEAD = "<tr>";

					for (i = 0; i < items.length; i++) {
						this.HEAD += "<th>" + items[i] + "</th>";
					}

					this.HEAD += "</tr>"
				}

				this.CreateBody = function(items) {
					this.BODY = "";

					for (i = 0; i < items.length; i++) {
						item = items[i];
						this.BODY += "<tr>";
						for (j = 0; j < item.length; j++) {
							this.BODY += "<td>" + item[j] + "</td>";
						}
						this.BODY += "</tr>";
					}
				}

				this.CreateTable = function() {
					this.HTML = this.DOMTable;

					this.HTML = this.HTML.split("[HEAD]").join(this.HEAD);
					this.HTML = this.HTML.split("[BODY]").join(this.BODY);

					return this.HTML;
				}

				this.UpdateTable = function(items) {
					html = "";

					for (i = 0; i < items.length; i++) {
						item = items[i];
						html += "<tr>";
						for (j = 0; j < item.length; j++) {
							html += "<td>" + item[j] + "</td>";
						}
						html += "</tr>";
					}

					document.getElementById("idMakeSense" + this.Name).innerHTML += html;
				}

				return this;
			}

			function TimerBuilder() {
				this.HTML = `
					<form>
						<div class="form-group">
							<label for="exampleInputEmail1">Timers</label>
							<div class="row">
								<div class="col">
									<input id="idMakeSenseStartTimer" type="text" class="form-control" placeholder="Time" data-date="" data-date-format="hh:ii" data-link-format="hh:ii>
									<span class="input-group-addon"><i class="glyphicon glyphicon-time"></i></span>
								</div>
							</div>
							<div class="row">
								<div class="col">
									<div class="btn-group" role="group" aria-label="First group">
										<button id="idMakeSenseTimerDay_1" type="button" class="btn btn-secondary" onClick="[OBJECT].UpdateDaySelection(1);">San</button>
										<button id="idMakeSenseTimerDay_2" type="button" class="btn btn-secondary" onClick="[OBJECT].UpdateDaySelection(2);">Mon</button>
										<button id="idMakeSenseTimerDay_3" type="button" class="btn btn-secondary" onClick="[OBJECT].UpdateDaySelection(3);">Tue</button>
										<button id="idMakeSenseTimerDay_4" type="button" class="btn btn-secondary" onClick="[OBJECT].UpdateDaySelection(4);">Wed</button>
										<button id="idMakeSenseTimerDay_5" type="button" class="btn btn-secondary" onClick="[OBJECT].UpdateDaySelection(5);">Thu</button>
										<button id="idMakeSenseTimerDay_6" type="button" class="btn btn-secondary" onClick="[OBJECT].UpdateDaySelection(6);">Fri</button>
										<button id="idMakeSenseTimerDay_7" type="button" class="btn btn-secondary" onClick="[OBJECT].UpdateDaySelection(7);">Sat</button>
									</div>
								</div>
							</div>
						</div>
						<div class="custom-control custom-checkbox my-1 mr-sm-2">
							<input type="checkbox" class="custom-control-input" id="idMakeSenseSelectAllDays" onClick="[OBJECT].UpdateDaySelection(8);">
							<label class="custom-control-label" for="idMakeSenseSelectAllDays">Whole week</label>
						</div>
						<div id="idMakeSenseTimerActionContent" class="btn-group" role="group" aria-label="First group">
						</div>
						<div class="form-group">
							<button type="button" class="btn btn-outline-primary my-1" onClick="[OBJECT].AddNewTimer();">Add new timer</button>
						</div>
						<div class="form-group">
							<label for="exampleInputEmail1">Current timers list</label>
							<div id="[OBJECT]_table"></div>
						</div>
					</form>
				`;

				this.Days 					= {};
				this.ClassName 				= "";
				this.TimerTable 			= new DOMTableContainer("Timer");
				this.UUID 					= "";
				this.Key 					= "";
				this.Actions 				= null;
				this.SelectedActionIndex 	= -1;
				this.LastId 				= 0;

				this.SetActions = function(actions) {
					this.Actions = actions;
					var html = "";
					for (i = 0; i < actions.length; i++) {
						html += "<button id=\"idMakeSenseTimerAction_" + i + "\" type=\"button\" class=\"btn btn-secondary\" onClick=\"" + this.ClassName + ".UpdateActionSelection(" + i + ");\">" + actions[i] + "</button>";
					}
					document.getElementById("idMakeSenseTimerActionContent").innerHTML = html;
				}

				this.UpdateActionSelection = function(index) {
					// Select all unchecked
					for (i = 0; i < this.Actions.length; i++) {
						document.getElementById("idMakeSenseTimerAction_" + i).classList.remove('btn-danger');
						document.getElementById("idMakeSenseTimerAction_" + i).classList.add('btn-secondary');
					}

					document.getElementById("idMakeSenseTimerAction_" + index).classList.remove('btn-secondary');
					document.getElementById("idMakeSenseTimerAction_" + index).classList.add('btn-danger');

					this.SelectedActionIndex = index;
				}

				this.Create = function(id, className) {
					this.ClassName = className;
					html = this.HTML.split("[OBJECT]").join(this.ClassName);
					document.getElementById(id).innerHTML = html;

					this.Days[1] = ["idMakeSenseTimerDay_1", 0, "SUN"];
					this.Days[2] = ["idMakeSenseTimerDay_2", 0, "MON"];
					this.Days[3] = ["idMakeSenseTimerDay_3", 0, "TUE"];
					this.Days[4] = ["idMakeSenseTimerDay_4", 0, "WED"];
					this.Days[5] = ["idMakeSenseTimerDay_5", 0, "THU"];
					this.Days[6] = ["idMakeSenseTimerDay_6", 0, "FRI"];
					this.Days[7] = ["idMakeSenseTimerDay_7", 0, "SAT"];
					this.Days[8] = ["idMakeSenseTimerAllDays", 0];

					$('#idMakeSenseStartTimer').datetimepicker({
						language:  'uk',
						weekStart: 1,
						todayBtn:  1,
						autoclose: 1,
						todayHighlight: 1,
						startView: 1,
						minView: 0,
						maxView: 1,
						forceParse: 0
					});
				}

				// Load status of days.
				this.Load = function(id) {
					self = this;
					this.UUID 	= id;

					api.SendCustomCommand(NodeUUID, "get_timer", {
						id: id
					}, function(res) {
						var payload = res.data.payload;
						console.log("TIMERS", payload);

						if (payload.timers !== undefined) {
							var objList = [];
							for (i = 0; i < payload.timers.length; i++) {
								var enabled = "Enabled";
								if ("0" == payload.timers[i].enabled) {
									enabled = "Disabled";
								}

								if ("All" == payload.timers[i].days) {
									days = "All";
								} else {
									days = payload.timers[i].days.join("<br>");
								}

								objList.push([payload.timers[i].start, days, payload.timers[i].action, enabled,"<span data-feather=\"delete\" onClick=\"" + self.ClassName + ".RemoveTimer(this, " + payload.timers[i].id + ");\"></span>"]);
								if (self.LastId < payload.timers[i].id) {
									self.LastId = payload.timers[i].id;
								}
							}

							self.TimerTable.CreateHead(["Start","Days","Action","Status",""]);
							self.TimerTable.CreateBody(objList);
							html = self.TimerTable.CreateTable();
							document.getElementById(self.ClassName + "_table").innerHTML = html;
							feather.replace();

							self.SetActions(payload.actions);
						}
					});
				}

				this.UpdateDaySelection = function(day) {
					if (8 == day) {
						for (i = 1; i < 8; i++) {
							if (0 == this.Days[day][1]) {
								document.getElementById(this.Days[i][0]).classList.remove('btn-secondary');
								document.getElementById(this.Days[i][0]).classList.add('btn-success');
								this.Days[i][1] = 1;
							} else {
								document.getElementById(this.Days[i][0]).classList.remove('btn-success');
								document.getElementById(this.Days[i][0]).classList.add('btn-secondary');
								this.Days[i][1] = 0;
							}
						}

						this.Days[day][1] = 1 - this.Days[day][1];

						return;
					}

					document.getElementById("idMakeSenseSelectAllDays").classList.remove("checked");
					document.getElementById("idMakeSenseSelectAllDays").checked = false;
					this.Days[8][1] = 0;

					if (0 == this.Days[day][1]) {
						document.getElementById(this.Days[day][0]).classList.remove('btn-secondary');
						document.getElementById(this.Days[day][0]).classList.add('btn-success');
						this.Days[day][1] = 1;
					} else {
						document.getElementById(this.Days[day][0]).classList.remove('btn-success');
						document.getElementById(this.Days[day][0]).classList.add('btn-secondary');
						this.Days[day][1] = 0;
					}		
				}

				this.AddNewTimer = function() {
					var SelectedDaysHtml 	= "";
					var SelectedDays  		= [];
					var SelectedAction 		= this.Actions[this.SelectedActionIndex];
					var SelectedStart 		= document.getElementById("idMakeSenseStartTimer").value;

					if ("" == SelectedStart) {
						return;
					}

					if (-1 == this.SelectedActionIndex) {
						return;
					}

					if (1 == this.Days[8][1]) {
						SelectedDaysHtml = "\"All\"";
						for (i = 1; i < 8; i++) {
							SelectedDays.push(this.Days[i][2]);
						}
					} else {
						for (i = 1; i < 8; i++) {
							if (1 == this.Days[i][1]) {
								SelectedDaysHtml += this.Days[i][2] + "<br>";
								SelectedDays.push(this.Days[i][2]);
							}
						}

						if ("" == SelectedDaysHtml) {
							return;
						}
					}

					this.TimerTable.UpdateTable([[SelectedStart, SelectedDaysHtml, SelectedAction, "Enabled", "<span data-feather=\"delete\" onClick=\"" + this.ClassName + ".RemoveTimer(this, " + this.LastId + ");\"></span>"]]);
					feather.replace();

					this.LastId += 1;
					api.SendCustomCommand(NodeUUID, "append_timer", {
						addr: this.UUID,
						timer: {
							id: this.LastId,
							start: SelectedStart,
							days: SelectedDays,
							action: SelectedAction,
							enabled: 1
						}
					}, function(res) {
						console.log("APPEND TIMER");
					});
				}

				this.RemoveTimer = function(self, id) {
					var element = self.parentNode.parentNode; // TR
					element.parentNode.removeChild(element);
					api.SendCustomCommand(NodeUUID, "remove_timer", {
						addr: this.UUID,
						id: this.LastId
					}, function(res) {
						console.log("REMOVE TIMER");
					});
				}

				return this;
			}

			function SetCheckboxState(id, val) {
				elem = document.getElementById(id);
				if (elem === null) {
					return;
				}

				if (val == 1) {
					elem.checked = true;
				} else if (val == 0) {
					elem.checked = false;
				}
			}
			
			// Gey makesense api instanse.
			var api = MkSAPIBuilder.GetInstance();
			api.SetGlobalGatewayIP(GatewayIP);

			var sensorModalView = `
				<div class="row">
					<div class="col-lg-12">
						<div class="card">
							<div class="card-body">
								<h7 class="d-flex justify-content-between align-items-center mb-3">
									<span class="text-muted">Name</span>
									<a href="#" id="id_sensor_name">N/A</a>
								</h7>
								<h7 class="d-flex justify-content-between align-items-center mb-3">
									<span class="text-muted">RF Type</span>
									<span id="id_sensor_rf_type">N/A</span>
								</h7>
								<h7 class="d-flex justify-content-between align-items-center mb-3">
									<span class="text-muted">Address</span>
									<span id="id_sensor_addr">N/A</span>
								</h7>
								<h7 class="d-flex justify-content-between align-items-center mb-3">
									<div class="custom-control custom-switch">
										<input id="id_sensor_recording" type="checkbox" class="custom-control-input">
										<label class="custom-control-label" for="id_sensor_recording">Recording (Enable/Disable)</label>
									</div>
								</h7>
								<h7 class="d-flex justify-content-between align-items-center mb-3">
									<div class="custom-control custom-switch">
										<input id="id_sensor_status" type="checkbox" class="custom-control-input">
										<label class="custom-control-label" for="id_sensor_status">Status (Enable/Disable)</label>
									</div>
								</h7>
								<h7 class="d-flex justify-content-between align-items-center mb-3">
									<div class="custom-control custom-switch">
										<input id="id_sensor_global_access" type="checkbox" class="custom-control-input">
										<label class="custom-control-label" for="id_sensor_global_access">Global Access (Enable/Disable)</label>
									</div>
								</h7>
								<div class="row">
									<div class="col-lg-3"><span onClick="ShowGraphMinus();" style="width: 16px; height: 16px; cursor: pointer" data-feather="chevron-left"></span></div>
									<div class="col-lg-6" id="id_date"></div>
									<div class="col-lg-3"><span onClick="ShowGraphPlus();" style="width: 16px; height: 16px; cursor: pointer" data-feather="chevron-right"></span></div>
								</div>
								<div id="id_graph_sensor"></div>
								<hr>
								<div id="id_timer"></div>
								<hr>
								<div id="id_sensor_custom"></div>
							</div>
						</div>
					</div>
				</div>
			`;
			var sensorModalFooterlView = `
				<button type="button" class="btn btn-primary" onclick="SaveSensorData('[ID]');">Save</button>
			`;
			var SensorCell = `
					<tr id="id_cell_sensor_[ID]">
						<td>[ICON]</td>
						<td>[NAME]</td>
						<td>[DESCRIPTION]</td>
						<td>[SENSOR]</td>
						<td><span onClick="OpenModal(this,'[ID]',[RF_TYPE], {name:'[NAME]',addr:[ADDR],www_access:[WWW_ACCESS],enabled:[ENABLED],recording:[RECORDING]}, 1);" style="width: 16px; height: 16px; cursor: pointer;color: green" data-feather="settings"></span></td>
						<td><span onClick="DeleteSensor([ADDR]);" style="width: 16px; height: 16px; cursor: pointer;color: red" data-feather="x"></span></td>
					</tr>
			`;

			var configureSensorModalView = `
				<div class="row">
					<div class="col-lg-12">
						<div class="card">
							<div class="card-body">
								<h7 class="d-flex justify-content-between align-items-center mb-3">
									<span class="text-muted">Device</span>
									<span id="id_sensor_config_dev">N/A</span>
								</h7>
								<h7 class="d-flex justify-content-between align-items-center mb-3">
									<span class="text-muted">RF Type</span>
									<span id="id_sensor_config_rf_type">N/A</span>
								</h7>
								<h7 class="d-flex justify-content-between align-items-center mb-3">
									<span class="text-muted">Address</span>
									<a href="#" id="id_sensor_config_addr">N/A</a>
								</h7>
								<div id="id_sensor_config_custom"></div>
							</div>
						</div>
					</div>
				</div>
			`;
			var configureSensorModalFooterlView = `
				<button type="button" class="btn btn-primary" onclick="SetSensorAddress('[ID]');">Save</button>
			`;

			var DeviceCell = `
					<div class="jumbotron">
						<h1 id="id_[TYPE]_name" class="display-4" style="color: [COLOR]">[NAME]</h1>
						<hr class="my-4">
						<p id="id_[TYPE]_state" class="lead">[STATE]</p>
					</div>
			`;
			var ConfigCell = `
					<tr id="id_cell_config_[ID]">
						<td>[ICON]</td>
						<td>[NAME]</td>
						<td>[DESCRIPTION]</td>
						<td><span onClick="OpenModal(this,'[ID]',[RF_TYPE], {addr:[ADDR]}, 2);" style="width: 16px; height: 16px; cursor: pointer;color: green" data-feather="settings"></span></td>
						<td><span onClick="AppendSensor([ADDR],[RF_TYPE]);" style="width: 16px; height: 16px; cursor: pointer;color: green" data-feather="plus"></span></td>
					</tr>
			`;

			$(function(){
				$.fn.editable.defaults.mode = 'inline';
			});

			var ConfigUIGenerate = function(device) {
				html = ConfigCell;
				html = html.split("[ID]").join(device.dev);
				html = html.split("[NAME]").join("Sensor");
				html = html.split("[RF_TYPE]").join(device.rf_type);
				html = html.split("[ADDR]").join(device.addr);
				html = html.split("[DESCRIPTION]").join("433MHz sensor");
				html = html.split("[ICON]").join(`<span style="width: 16px; height: 16px; color: red" data-feather="activity"></span>`);

				return html;
			}

			var SensorUIGenerate = function(sensor) {
				html = SensorCell;
				html = html.split("[ID]").join(sensor.addr);
				html = html.split("[NAME]").join(sensor.name);
				html = html.split("[RF_TYPE]").join(sensor.rf_type);

				html = html.split("[ADDR]").join(sensor.addr);
				html = html.split("[WWW_ACCESS]").join(sensor.access_from_www);
				html = html.split("[ENABLED]").join(sensor.enable);
				html = html.split("[RECORDING]").join(sensor.recording);

				var htmlType = "";
				switch(sensor.type) {
					case 1:
						if (txState == 1) {
							html = html.split("[ICON]").join(`<span style="width: 16px; height: 16px; color: red" data-feather="sun"></span>`);
							htmlType = `
								<div class="custom-control custom-switch">
									<input type="checkbox" class="custom-control-input" [DISABLED] [STATE] onchange="SwitchChanged(this, [ADDR]);" id="switch_id_[SWITCH_ID]">
									<label class="custom-control-label" for="switch_id_[SWITCH_ID]"></label>
								</div>
							`;
							htmlType = htmlType.split("[DISABLED]").join("");
							if (sensor.value == 0) {
								htmlType = htmlType.split("[STATE]").join("");
							} else {
								htmlType = htmlType.split("[STATE]").join("checked");
							}
							htmlType = htmlType.split("[ADDR]").join(sensor.addr);
							htmlType = htmlType.split("[SWITCH_ID]").join(sensor.addr);
						} else {
							html = html.split("[ICON]").join(`<span style="width: 16px; height: 16px; color: red" data-feather="sun"></span>`);
							htmlType = `<span style="color: black">DISABLED</span>`;
						}

						html = html.split("[DESCRIPTION]").join("433MHz Switch");
					break;
					case 2:
						if (rxState == 1) {
							html = html.split("[ICON]").join(`<span style="width: 16px; height: 16px; color: green" data-feather="eye"></span>`);
							if (sensor.value == 0) {
								htmlType = `
									<span id="senor_motion_id_[ADDR]" style="width: 16px; height: 16px; color: black" data-feather="user"></span>
								`;
							} else {
								htmlType = `
									<span id="senor_motion_id_[ADDR]" style="width: 16px; height: 16px; color: black" data-feather="user-check"></span>
								`;
							}
							htmlType = htmlType.split("[ADDR]").join(sensor.addr);
						} else {
							html = html.split("[ICON]").join(`<span style="width: 16px; height: 16px; color: green" data-feather="eye"></span>`);
							htmlType = `<span style="color: black">DISABLED</span>`;
						}
						html = html.split("[DESCRIPTION]").join("433MHz Motion sensor (PIR)");
					break;
					case 3:
						if (rxState == 1) {
							html = html.split("[ICON]").join(`<span style="width: 16px; height: 16px; color: green" data-feather="layers"></span>`);
							if (sensor.value.motion == 0) {
								htmlType = `
									<span id="senor_motion_id_[ADDR]" style="width: 16px; height: 16px; color: black" data-feather="user"></span>
								`;
							} else {
								htmlType = `
									<span id="senor_motion_id_[ADDR]" style="width: 16px; height: 16px; color: black" data-feather="user-check"></span>
								`;
							}
							htmlType += `
								<span id="senor_temperature_id_[ADDR]" style="color: black">[TEMPERATURE]C</span>
							`;
							htmlType += `
								<span id="senor_humidity_id_[ADDR]" style="color: black">[HUMIDITY]H</span>
							`;
							htmlType = htmlType.split("[ADDR]").join(sensor.addr);
							htmlType = htmlType.split("[TEMPERATURE]").join(sensor.value.temperature);
							htmlType = htmlType.split("[HUMIDITY]").join(sensor.value.humidity);
						} else {
							html = html.split("[ICON]").join(`<span style="width: 16px; height: 16px; color: green" data-feather="layers"></span>`);
							htmlType = `<span style="color: black">DISABLED</span>`;
						}
						html = html.split("[DESCRIPTION]").join("433MHz PIR, Temp & Humi sensor");
					break;
					case 4:
						if (rxState == 1) {
							html = html.split("[ICON]").join(`<span style="width: 16px; height: 16px; color: green" data-feather="layers"></span>`);
							htmlType += `
								<span id="senor_temperature_id_[ADDR]" style="color: black">[TEMPERATURE]C</span>
							`;
							htmlType += `
								<span id="senor_humidity_id_[ADDR]" style="color: black">[HUMIDITY]H</span>
							`;
							htmlType = htmlType.split("[ADDR]").join(sensor.addr);
							htmlType = htmlType.split("[TEMPERATURE]").join(sensor.value.temperature);
							htmlType = htmlType.split("[HUMIDITY]").join(sensor.value.humidity);
						} else {
							html = html.split("[ICON]").join(`<span style="width: 16px; height: 16px; color: green" data-feather="layers"></span>`);
							htmlType = `<span style="color: black">DISABLED</span>`;
						}
						html = html.split("[DESCRIPTION]").join("433MHz Temp & Humi sensor");
					break;
				}
				html = html.split("[SENSOR]").join(htmlType);
				return html;
			}

			var DeviceUIGenerate = function(type, device) {
				htmlDevice = DeviceCell;
				htmlDevice = htmlDevice.split("[NAME]").join(type);
				htmlDevice = htmlDevice.split("[TYPE]").join(type);

				if (device.state == 1) {
					htmlDevice = htmlDevice.split("[COLOR]").join("green");
					htmlDevice = htmlDevice.split("[STATE]").join("Connected");
				} else {
					htmlDevice = htmlDevice.split("[COLOR]").join("red");
					htmlDevice = htmlDevice.split("[STATE]").join("Not Connected");
				}
				return htmlDevice;
			}

			var DeleteSensor = function(addr) {
				payload = {
					addr: addr
				};
				
				api.SendCustomCommand(NodeUUID, "remove_sensor_to_db", payload, function(res) {
					var payload = res.data.payload;
					if (payload.sensors !== undefined) {
						BuildUISensors(payload.sensors);
					}
				});
			}

			var AppendSensor = function(addr, rf_type) {
				payload = {
					addr: addr,
					rf_type: rf_type
				};
				
				api.SendCustomCommand(NodeUUID, "append_sensor_to_db", payload, function(res) {
					var payload = res.data.payload;
					if (payload.sensors !== undefined) {
						BuildUISensors(payload.sensors);
					}
				});
			}

			var SetSensorAddress = function(id) {
				// TODO - Check if address is not existed
				addr = document.getElementById("id_sensor_config_addr").innerHTML;
				payload = {
					addr: parseInt(addr, 10),
					dev: id
				};
				api.SendCustomCommand(NodeUUID, "set_sensor_addr", payload, function(res) {
					var payload = res.data.payload;
					if (payload !== undefined) {
						BuildUIConfigSensors(payload.config_sensors);
					}
				});
			}

			var SaveSensorData = function(addr) {
				name 		= document.getElementById("id_sensor_name").innerHTML;
				recording	= (document.getElementById("id_sensor_recording").checked) ? 1 : 0;
				enable		= (document.getElementById("id_sensor_status").checked) ? 1 : 0;
				www_access 	= (document.getElementById("id_sensor_global_access").checked) ? 1 : 0;
				payload = {
					addr: parseInt(addr, 10),
					name: name,
					recording: recording,
					enable: enable,
					access_from_www: www_access
				};
				api.SendCustomCommand(NodeUUID, "save_sensor_to_db", payload, function(res) {
					var payload = res.data.payload;
					if (payload.sensors !== undefined) {
						BuildUISensors(payload.sensors);
					}
				});
			}

			var SwitchChanged = function(elem, addr) {
				var value = 0;
				if (elem.checked) {
					var value = 1;
				}

				api.SendCustomCommand(NodeUUID, "write_sensor_info", {
					addr: addr,
					value: value
				}, function(res) { });
			};

			var UpdateMotionSesnor = function(addr, value) {
				var element = document.getElementById("senor_motion_id_" + addr);
				if (element !== undefined && element != null) {
					if (value == "1") {
						element.style.color = "red";
						element.setAttribute("data-feather", "user-check");
					} else {
						element.style.color = "black";
						element.setAttribute("data-feather", "user");
					}
				}
			}

			var UpdateTemperatureSesnor = function(addr, value) {
				var element = document.getElementById("senor_temperature_id_" + addr);
				if (element !== undefined && element != null) {
					element.innerHTML = value + "C";
				}
			}

			var UpdateHumiditySesnor = function(addr, value) {
				var element = document.getElementById("senor_humidity_id_" + addr);
				if (element !== undefined && element != null) {
					element.innerHTML = value + "H";
				}
			}
			
			var UpdateSwitch = function(addr, value) {
				SetCheckboxState("switch_id_"+addr, value);
			}

			var OnNodeChangeEvent = function(packet) {
				console.log("OnNodeChangeEvent", packet.data.payload.event);
				switch(packet.data.payload.event) {
					case "device_append": {
						console.log(packet.data.payload);
						switch(packet.data.payload.rf_type) {
							case 1: {
								document.getElementById("id_TX_name").style.color = "green";
								document.getElementById("id_TX_state").innerHTML = "Connected";
							}
							break;
							case 2: {
								document.getElementById("id_RX_name").style.color = "green";
								document.getElementById("id_RX_state").innerHTML = "Connected";
							}
							break;
							case 3:
							case 4:
							case 5:
							case 6: {
								sensor = {
									dev: packet.data.payload.dev,
									rf_type: packet.data.payload.rf_type,
									addr: packet.data.payload.addr
								}
								document.getElementById("config_sensors_list_id").innerHTML += ConfigUIGenerate(sensor);
								feather.replace();
							}
							break;
							default:
							break;
						}

						api.GetNodeSensorsInfo(NodeUUID, function(res) {
							BuildUI(res.data.payload);
						});
					}
					break;
					case "device_remove": {
						console.log(packet.data.payload);
						switch(packet.data.payload.rf_type) {
							case 1: {
								document.getElementById("id_TX_name").style.color = "red";
								document.getElementById("id_TX_state").innerHTML = "Not Connected";
							}
							break;
							case 2: {
								document.getElementById("id_RX_name").style.color = "red";
								document.getElementById("id_RX_state").innerHTML = "Not Connected";
							}
							break;
							case 3:
							case 4:
							case 5:
							case 6: {
								console.log("id_cell_config_" + packet.data.payload.dev);
								var element = document.getElementById("id_cell_config_" + packet.data.payload.dev);
								element.innerHTML = "";
							}
							break;
							default:
							break;
						}
						api.GetNodeSensorsInfo(NodeUUID, function(res) {
							BuildUI(res.data.payload);
						});
					}
					break;
					case "sensor_value_change": {
						console.log(packet.data.payload);
						var sensor = packet.data.payload.sensor;

						if (sensor.rf_type == 3) {
							// SWITCH
							UpdateSwitch(sensor.addr, sensor.value);
						} else if (sensor.rf_type == 4) {
							// MOTION
							UpdateMotionSesnor(sensor.addr, sensor.value);
							feather.replace();
						} else if (sensor.rf_type == 5) {
							// MOTION and DHT11
							UpdateMotionSesnor(sensor.addr, sensor.motion);
							UpdateTemperatureSesnor(sensor.addr, sensor.temperature);
							UpdateHumiditySesnor(sensor.addr, sensor.humidity);
							feather.replace();
						} else if (sensor.rf_type == 6) {
							// DHT11
							UpdateTemperatureSesnor(sensor.addr, sensor.temperature);
							UpdateHumiditySesnor(sensor.addr, sensor.humidity);
							feather.replace();
						}else {

						}
					}
					break;
				}
			}

			var BuildUISensors = function(sensors) {
				var htmlSensors = `
				<div class="table-responsive">
					<table class="table table-striped table-sm">
						<thead>
							<tr>
								<th>Icon</th>
								<th>Name</th>
								<th>Description</th>
								<th>Value</th>
								<th>Settings</th>
								<th>Delete</th>
							</tr>
						</thead>
						<tbody>`;
				for (var key in sensors) {
					sensor = sensors[key];
					htmlSensors += SensorUIGenerate(sensor);
				}
				htmlSensors += `</tbody></table></div>`;
				document.getElementById("sensors_list_id").innerHTML = htmlSensors;
				document.getElementById("sensors_count_id").innerHTML = sensors.length;
				
				feather.replace();
			}

			var BuildUIConfigSensors = function(config_sensors) {
				console.log("->", config_sensors);
				var htmlConfigSensors = `
				<div class="table-responsive">
					<table class="table table-striped table-sm">
						<thead>
							<tr>
								<th>Icon</th>
								<th>Name</th>
								<th>Description</th>
								<th>Settings</th>
								<th>Add</th>
							</tr>
						</thead>
						<tbody id="config_sensors_list_id">`;
				for (var key in config_sensors) {
					sensor = config_sensors[key];
					htmlConfigSensors += ConfigUIGenerate(sensor);
				}
				htmlConfigSensors += `</tbody></table></div>`;
				document.getElementById("devices_list_id").innerHTML = htmlConfigSensors;
				document.getElementById("devices_count_id").innerHTML = config_sensors.length;
				
				feather.replace();
			}

			var BuildUI = function(data) {
				sensors = data.sensors;
				devices = data.devices;
				config_sensors = data.config_sensors;

				rxState = devices.rx.state;
				txState = devices.tx.state;
				
				htmlDevice = DeviceUIGenerate("TX", devices.tx);
				document.getElementById("id_tx_device").innerHTML = htmlDevice;
				htmlDevice = DeviceUIGenerate("RX", devices.rx);
				document.getElementById("id_rx_device").innerHTML = htmlDevice;

				BuildUIConfigSensors(config_sensors);
				BuildUISensors(sensors);

				feather.replace();
			}

			api.ConnectGateway(function() {
				console.log("Connection to Gateway was established.");
				api.Gateway.OnNodeChangeEvent = OnNodeChangeEvent;

				api.GetNodeSensorsInfo(NodeUUID, function(res) {
					console.log(res.data.payload);
					BuildUI(res.data.payload);

					api.RegisterOnNodeChange(NodeUUID, function(res) {
						console.log("REGISTERED", res);
					});
				});
			});

			$('#id-semsor-modal').on('hide.bs.modal', function (e) {
				
			})

			var g_date = new Date();
			var g_current_day = 0;
			var g_current_month = 0;
			var g_current_year = 0;
			var g_rf_type = 0;
			var g_addr = 0;

			var GetGraphData = function () {
				console.log(g_current_year, g_current_month, g_current_day);
				api.SendCustomCommand(NodeUUID, "sensors_graph", {
					rf_type: g_rf_type,
					addr: g_addr,
					year: String(g_current_year),
					month: String(g_current_month),
					day: String(g_current_day)
				}, function(res) {
					var payload = res.data.payload;
					console.log("GRAPH", payload);
					
					document.getElementById("id_graph_sensor").innerHTML = "";
					for (i = 0; i < payload.sensors; i++) {
						document.getElementById("id_graph_sensor").innerHTML += `
							<canvas class="my-4 w-100" id="chart_` + i + `"></canvas>
						`;
					}
					for (i = 0; i < payload.sensors; i++) {
						lables_data = [];
						graph_data = [];

						console.log(document.getElementById("id_graph_sensor").innerHTML);

						for (j = 0; j < payload.graph.length; j++) {
							lables_data.push(j);
							graph_data.push(payload.graph[j][i]);
						}

						var ctx = document.getElementById('chart_' + i)
						var myChart = new Chart(ctx, {
							type: 'bar',
							data: {
								labels: lables_data,
								datasets: [{
									data: graph_data,
									lineTension: 0,
									backgroundColor: 'transparent',
									borderColor: '#007bff',
									borderWidth: 4,
									pointBackgroundColor: '#007bff'
								}]
							},
							options: {
								scales: {
									yAxes: [{
										ticks: {
											beginAtZero: false
										}
									}]
								},
								legend: {
									display: false
								}
							}
						})
					}
				});
			}

			var ShowGraphMinus = function() {
				g_date.setDate(g_date.getDate() - 1);
				document.getElementById("id_date").innerHTML = g_date.toDateString();

				g_current_year = g_date.getFullYear();
				g_current_month = g_date.getMonth() + 1;
				g_current_day = g_date.getDate();

				GetGraphData();
			}

			var ShowGraphPlus = function() {
				g_date.setDate(g_date.getDate() + 1);
				document.getElementById("id_date").innerHTML = g_date.toDateString();

				g_current_year = g_date.getFullYear();
				g_current_month = g_date.getMonth() + 1;
				g_current_day = g_date.getDate();

				GetGraphData();
			}

			var g_timer;
			var OpenModal = function (elem, id, rf_type, obj, selector) {
				switch(rf_type) {
					case 1:
						document.getElementById("id_modal_content").innerHTML 	= "";
						document.getElementById("id_modal_footer").innerHTML 	= "";
					break;
					case 2:
						document.getElementById("id_modal_content").innerHTML 	= "";
						document.getElementById("id_modal_footer").innerHTML 	= "";
					break;
					case 3:
					case 4:
					case 5:
					case 6:
						if (selector == 1) {
							html = sensorModalFooterlView
							html = html.split("[ID]").join(id);
							document.getElementById("id_modal_content").innerHTML 			= sensorModalView;
							document.getElementById("id_modal_footer").innerHTML 			= html;
							document.getElementById("id_sensor_addr").innerHTML 			= obj.addr;
							document.getElementById("id_sensor_rf_type").innerHTML 			= rf_type; 
							document.getElementById("id_sensor_name").innerHTML 			= obj.name; 
							$('#id_sensor_name').editable({
								type:  'text',
								name:  'name',
								title: 'name'
							});
							SetCheckboxState("id_sensor_global_access", obj.www_access);
							SetCheckboxState("id_sensor_status", obj.enabled);
							SetCheckboxState("id_sensor_recording", obj.recording);

							g_date = new Date();
							document.getElementById("id_date").innerHTML = g_date.toDateString();

							g_current_year = g_date.getFullYear();
							g_current_month = g_date.getMonth() + 1;
							g_current_day = g_date.getDate();
							g_rf_type = rf_type;
							g_addr = id;

							g_timer = new TimerBuilder();
							console.log(document.getElementById("id_timer").innerHTML);
							g_timer.Create("id_timer", "g_timer");
							g_timer.Load(id);

							GetGraphData();
						} else {
							html = configureSensorModalFooterlView
							html = html.split("[ID]").join(id);
							document.getElementById("id_modal_content").innerHTML 			= configureSensorModalView;
							document.getElementById("id_modal_footer").innerHTML 			= html;
							document.getElementById("id_sensor_config_dev").innerHTML 		= id;
							document.getElementById("id_sensor_config_addr").innerHTML 		= obj.addr;
							document.getElementById("id_sensor_config_rf_type").innerHTML 	= rf_type; 
							$('#id_sensor_config_addr').editable({
								type:  'text',
								name:  'addr',
								title: 'addr'
							});
						}
					break;
				}
				feather.replace();
				$('#id-semsor-modal').modal('show')
			}

			feather.replace();
        </script>
    </body>
</html>