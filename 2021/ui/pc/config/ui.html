<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="description" content="">
        <meta name="author" content="">

        <title>USB Cameras</title>

		[CSS]

		<link rel="stylesheet" href="/static/lib/bootstrap/css/bootstrap.min.css" crossorigin="anonymous">
		<link rel="stylesheet" href="/static/lib/bootstrap/css/bootstrap-slider.css" crossorigin="anonymous">
		<link rel="stylesheet" href="/static/lib/fontawesome-5.11.2/css/all.min.css">
		<link rel="stylesheet" href="/static/lib/bootstrap4-editable/css/bootstrap-editable.css">
		<link rel="stylesheet" href="/static/lib/chartjs/2.9.3/Chart.min.css">
		<link rel="stylesheet" href="/static/lib/datetimepicker/bootstrap-datetimepicker.min.css">
     
        <style>
            body {
              font-size: .875rem;
            }
            .feather {
              width: 16px;
              height: 16px;
              vertical-align: text-bottom;
            }
            html {
              position: relative;
              min-height: 100%;
            }
            body {
              /* Margin bottom by footer height */
              margin-bottom: 60px;
            }
            .footer {
              position: absolute;
              bottom: 0;
              width: 100%;
              /* Set the fixed height of the footer here */
              height: 60px;
              line-height: 60px; /* Vertically center the text there */
              background-color: #f5f5f5;
            }
            body > .container {
              padding: 60px 15px 0;
            }
            .footer > .container {
              padding-right: 15px;
              padding-left: 15px;
            }
            code {
              font-size: 80%;
            }
        </style>

        <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
        <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
        <!--[if lt IE 9]>
          <script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
          <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
        <![endif]-->
    </head>
	<body>
		<main role="main" class="container">
			<div class="row">
				<div class="col-lg-2"></div>
				<div class="col-lg-8">
					<div class="card">
						<div class="card-body">
							<div class="row">
								<div class="media">
									<img class="mr-3" alt="..." style="height: 48px;" id="selected_image" data-obj="mks" src="resource/img/mp3.jpeg" />
									<div class="media-body">
										<h6 class="mt-0" id="id-current-active-song">Media Name</h6>
										<p><span id="id-current-active-song-position">00:00:00</span><span id="id-current-active-song-duration">(00:00:00)</span></p>
									</div>
								</div>
							</div>
							<br>
							<div class="row">
								<div class="table-responsive">
									<table class="table table-striped table-lg">
										<tr>
											<td align="center"><span onclick="node.Player.Back();" style="width: 32px; height: 32px; color: red; cursor: pointer" data-feather="skip-back"></span></td>
											<td align="center"><span onclick="node.Player.Play();" style="width: 32px; height: 32px; color: red; cursor: pointer" data-feather="play"></span></td>
											<td align="center"><span onclick="node.Player.Pause();" style="width: 32px; height: 32px; color: red; cursor: pointer" data-feather="pause"></span></td>
											<td align="center"><span onclick="node.Player.Stop();" style="width: 32px; height: 32px; color: red; cursor: pointer" data-feather="square"></span></td>
											<td align="center"><span onclick="node.Player.Forward();" style="width: 32px; height: 32px; color: red; cursor: pointer" data-feather="skip-forward"></span></td>
										</tr>
									</table>
								</div>
							</div>
							<div class="row">
								<div class="table-responsive">
									<table class="table table-striped table-lg">
										<tr>
											<td style="width: 80%;" align="center" id="id-player-duration"><input onmouseup="node.Player.ChangePlayingPosition();" style="width: 100%" type="range" class="custom-range" min="0" max="1000000" step="1" id="id-stream-offset"></td>
											<td style="width: 20%;" align="center"><input onmouseup="node.Player.ChangeVolumePosition();" type="range" class="custom-range" min="0" max="100" step="1" id="id-volume-offset"></td>
										</tr>
									</table>
								</div>
							</div>
							<div class="row">
								<div class="table-responsive">
									<table class="table table-striped table-lg">
										<tr>
											<td align="center"><a href="#">Create Folder</a></td>
											<td align="center" onClick="node.Uploader.Show();"><a href="#">Upload Song</a></td>
											<td align="center"><a href="#">Select Music Folder</a></td>
											<td align="center"><a href="#">Select Speakers</a></td>
										</tr>
									</table>
								</div>
							</div>
						</div>
					</div>
				</div>
				<div class="col-lg-2"></div>
			</div>
			<br>
        	<div class="row">
				<div class="col-lg-2"></div>
        	    <div class="col-lg-8">
        	        <div class="card">
						<div class="card-body">
							<ul class="list-unstyled" id="id_song_list">
							</ul>
						</div>
                  	</div>
				</div>
				<div class="col-lg-2"></div>
			</div>
        </main>

		<script src="/static/lib/nodes/js/jquery_3_3_1/jquery.min.js"></script>
		<script src="/static/lib/nodes/js/popper_1_14_7/popper.min.js" crossorigin="anonymous"></script>
		<script src="/static/lib/bootstrap/js/bootstrap.min.js" crossorigin="anonymous"></script>
		<script src="/static/lib/bootstrap/js/bootstrap-slider.js" crossorigin="anonymous"></script>
		<script src="/static/lib/nodes/js/feather_4_19/feather.min.js"></script>
		<script src="/static/lib/nodes/map/feather_4_19/feather.min.js.map"></script>
		<script src="/static/lib/bootstrap4-editable/js/bootstrap-editable.min.js"></script>
		<script src="/static/lib/chartjs/2.9.3/Chart.min.js"></script>
		<script src="/static/lib/datetimepicker/bootstrap-datetimepicker.min.js"></script>
		<script src="/static/lib/crypto-js/3.1.2/components/core.js"></script>
		<script src="/static/lib/crypto-js/3.1.2/components/md5.js"></script>
		<script src="/mksdk-js/widgets/basic_modal.js"></script>
		<script src="/mksdk-js/widgets/basic_uploader.js"></script>

		[SCRIPTS]

        <script>
          	var GatewayIP = "[GATEWAY_IP]";
			var NodeUUID  = "[NODE_UUID]";

			String.prototype.format = function (args) {
				var str = this;
				return str.replace(String.prototype.format.regex, function(item) {
					var intVal = parseInt(item.substring(1, item.length - 1));
					var replace;
					if (intVal >= 0) {
						replace = args[intVal];
					} else if (intVal === -1) {
						replace = "{";
					} else if (intVal === -2) {
						replace = "}";
					} else {
						replace = "";
					}
					return replace;
				});
			};
			String.prototype.format.regex = new RegExp("{-?[0-9]+}", "g");

			$(document).ready(function() {
				// data-toggle="tooltip" title="Tooltip on right"
				$('[data-toggle="tooltip"]').tooltip();
			});

			function Node() {
				var self = this;

				// Get makesense api instanse.
				this.API  		= MkSAPIBuilder.GetInstance();
				this.Player 	= new Player(this.API);
				this.PlayList 	= new PlayList(this.API);
				this.Uploader	= MksBasicUploaderBuilder.GetInstance();
				this.Uploader.SetAPI(this.API);
				this.Uploader.SetModal(true);
				this.Uploader.SetFileType("audio/mpeg");
				this.Uploader.Build(null, "Upload");
				this.Uploader.OnUploadCompete = this.OnUploadCompleteHandler;
				// Update gateway IP address
				this.API.SetGlobalGatewayIP(GatewayIP);
				// Default handler
				this.API.OnUnexpectedDataArrived = function (packet) {
					console.log(packet);
				}

				return this;
			}

			Node.prototype.Init = function() {
				node.Player.Objects.CurrentRangeStreamOffset.oninput = function() {
					node.Player.Ctx.user_position = this.value;
				} 

				node.Player.Objects.CurrentVolumeOffset.oninput = function() {
					node.Player.Ctx.user_volume = this.value;
				} 
			}

			Node.prototype.OnChangeEvent = function(packet) {
				console.log("OnNodeChangeEvent", this, packet.data.payload.event);
				data = packet.data.payload.data;
				switch(packet.data.payload.event) {
					case "media_folder_changed": {
						var objSongList = document.getElementById("id_song_list");
						var songsList = data.songs;
						for (key in songsList) {
							song = songsList[key];
							switch(song.status) {
								case "append": {
									var song_id = CryptoJS.MD5(song.item).toString();
									objSongList.innerHTML += this.PlayList.GenerateSongItemView({
										name: song.item,
										id: song_id
									});
									node.API.SendCustomCommand(NodeUUID, 'get_resource', { 
																					"id": "img_" + song_id, 
																					"tag": "img", 
																					"src": "resource/img/song.jpeg", 
																					"ui_type": 'config' }, function(res) { 
										var payload = res.data.payload; 
										document.getElementById(payload.id).src = MkSGlobal.ConvertHEXtoString(payload.content); 
									});
								}
								break;
								case "remove": {
									var song_id = CryptoJS.MD5(song.item).toString();
									var objSong = document.getElementById("id_"+song_id);
									var objLine = document.getElementById("id_line_"+song_id);
									objSong.remove();
									objLine.remove();
								}
								break;
								default:
								break;
							}
						}
					}
					break;
					case "media_info": {
						this.Player.PlayerHandlers[data.info.state](this.Player, data.info);
						// Update volume UI object
						this.Player.Objects.CurrentVolumeOffset.value = data.info.volume;
					}
					break;
					case "upload_progress": {
						this.Uploader.UpdateProgress(data);
					}
					break;
				}
			}

			Node.prototype.Connect = function() {
				var self = this;
				console.log("Connect Gateway");
				this.API.ConnectGateway(function() {
					console.log("Connection to Gateway was established.");
					self.API.Gateway.OnNodeChangeEvent = self.OnChangeEvent.bind(self);
					self.API.GetNodeSensorsInfo(NodeUUID, function(res) {
						UserGetNodeSensorInfoHandler(res);
					});
				});
			}
			
			Node.prototype.OnUploadCompleteHandler = function () {
				node.Uploader.Hide();
			}

			function Player (api) {
				self = this;

				this.SongList 			= [];
				this.SongsCount 		= 0;
				this.PlayingSongIndex 	= 0;

				this.Ctx = {
					state: "IDLE",
					name: "",
					id: 0,
					position: 0,
					duration_ms: 0,
					play_worker_idx: 0,
					user_position: 0,
					user_volume: 50
				};

				this.Objects = {
					CurrentActiveSong: 				document.getElementById("id-current-active-song"),
					CurrentActiveSongDuration: 		document.getElementById("id-current-active-song-duration"),
					CurrentActiveSongPosition: 		document.getElementById("id-current-active-song-position"),
					CurrentRangeStreamOffset:		document.getElementById("id-stream-offset"),
					CurrentVolumeOffset:			document.getElementById("id-volume-offset")
				}

				this.API = api;

				this.PlayerHandlers = {
					"IDLE": 	this.IdleCallback,
					"PAUSE": 	this.PauseCallback,
					"PLAY": 	this.PlayCallback,
					"STOP": 	this.StopCallback,
					"END":		this.EndCallback
				}

				return this;
			}

			Player.prototype.IdleCallback = function(ctx, info) {
				// Init UI
				ctx.Objects.CurrentActiveSong.innerHTML 			= "Media Name";
				ctx.Objects.CurrentActiveSongPosition.innerHTML		= "00:00:00";
				ctx.Objects.CurrentActiveSongDuration.innerHTML 	= " (00:00:00)";

				// Init player context
				ctx.Ctx.name 			= "";
				ctx.Ctx.user_position 	= 0;
				ctx.Ctx.position 		= 0;
				ctx.Ctx.duration_ms 	= 0;
				ctx.Ctx.play_worker_idx = 0;
			}

			Player.prototype.EndCallback = function(ctx, info) {
				clearInterval(ctx.Ctx.play_worker_idx);
				ctx.Ctx.play_worker_idx = 0;

				// Init UI
				ctx.Objects.CurrentActiveSong.innerHTML 			= "Media Name";
				ctx.Objects.CurrentActiveSongPosition.innerHTML		= "00:00:00";
				ctx.Objects.CurrentActiveSongDuration.innerHTML 	= " (00:00:00)";

				// Init player context
				ctx.Ctx.name 			= "";
				ctx.Ctx.user_position 	= 0;
				ctx.Ctx.position 		= 0;
				ctx.Ctx.duration_ms 	= 0;
				ctx.Ctx.play_worker_idx = 0;
			}

			Player.prototype.SetSong = function(song) {
				this.Ctx.name 	= song.name;
			}

			Player.prototype.Play = function() {
				payload = {
					operation: "play",
					song: {
						name: this.Ctx.name
					}
				};
				this.API.SendCustomCommand(NodeUUID, "player_operation", payload, this.RouterHandler.bind(this));
			}

			Player.prototype.PlayCallback = function(ctx, info) {
				var milliseconds = info.duration;
				var seconds = (milliseconds / 1000) % 60 ;
				var minutes = ((milliseconds / (1000*60)) % 60);
				var hours   = ((milliseconds / (1000*60*60)) % 24);

				ctx.Objects.CurrentActiveSong.innerHTML 			= info.name;
				ctx.Objects.CurrentActiveSongDuration.innerHTML 	= " ({0}:{1}:{2})".format([parseInt(hours), parseInt(minutes), parseInt(seconds)]);
				ctx.Ctx.name 										= info.name;

				if (!ctx.Ctx.play_worker_idx) {
					ctx.Ctx.play_worker_idx = setInterval(ctx.WorkerInterval.bind(ctx), 1000);
				}

				ctx.Ctx.position 		= info.position / 1000;
				ctx.Ctx.duration_ms 	= milliseconds;
				ctx.Ctx.state 			= info.state;

				ctx.Objects.CurrentRangeStreamOffset.max 	= milliseconds / 1000;
				ctx.Objects.CurrentRangeStreamOffset.step 	= "1";
				ctx.Objects.CurrentRangeStreamOffset.value = ctx.Ctx.position;

				var song_id = CryptoJS.MD5(info.name).toString();
				if (song_id != ctx.Ctx.id) {
					for (key in ctx.SongList) {
						song = ctx.SongList[key];
						if (song.id == song_id) {
							ctx.PlayingSongIndex 	= parseInt(key);
							ctx.Ctx.id 				= song_id;
							break;
						}
					}
				}
				
			}

			Player.prototype.Stop = function() {
				payload = {
					operation: "stop",
					song: {
						name: this.Ctx.name
					}
				};
				this.API.SendCustomCommand(NodeUUID, "player_operation", payload, this.RouterHandler.bind(this));
			}

			Player.prototype.StopCallback = function(ctx, info) {
				clearInterval(ctx.Ctx.play_worker_idx);
				ctx.Ctx.play_worker_idx = 0;
			}

			Player.prototype.Pause = function() {
				payload = {
					operation: "pause",
					song: {
						name: this.Ctx.name
					}
				};
				this.API.SendCustomCommand(NodeUUID, "player_operation", payload, this.RouterHandler.bind(this));
			}

			Player.prototype.PauseCallback = function(ctx, info) {
				clearInterval(ctx.Ctx.play_worker_idx);
				ctx.Ctx.play_worker_idx = 0;
			}

			Player.prototype.Back = function() {
				var song = null;
				if (this.PlayingSongIndex == 0) {
					song = this.SongList[this.SongsCount-1];
				} else {
					song = this.SongList[this.PlayingSongIndex-1];
				}

				this.SetSong(song);
				this.Play();
			}

			Player.prototype.Forward = function() {
				var song = null;
				if (this.PlayingSongIndex == this.SongsCount-1) {
					song = this.SongList[0];
				} else {
					song = this.SongList[this.PlayingSongIndex+1];
				}

				this.SetSong(song);
				this.Play();
			}

			Player.prototype.WorkerInterval = function() {
				this.Ctx.position += 1;

				var seconds = (this.Ctx.position) % 60 ;
				var minutes = ((this.Ctx.position / 60) % 60);
				var hours   = ((this.Ctx.position / (60*60)) % 24);

				this.Objects.CurrentActiveSongPosition.innerHTML 	= "{0}:{1}:{2}".format([parseInt(hours), parseInt(minutes), parseInt(seconds)]);
				this.Objects.CurrentRangeStreamOffset.value 		= this.Ctx.position;
			}

			Player.prototype.ChangePlayingPosition = function() {
				payload = {
					operation: "set_time",
					song: {
						time: this.Ctx.user_position * 1000
					}
				};
				this.API.SendCustomCommand(NodeUUID, "player_operation", payload, this.RouterHandler.bind(this));
			}

			Player.prototype.ChangeVolumePosition = function() {
				payload = {
					operation: "set_volume",
					song: {
						volume: parseInt(this.Ctx.user_volume)
					}
				};
				this.API.SendCustomCommand(NodeUUID, "player_operation", payload, this.RouterHandler.bind(this));
			}

			Player.prototype.RouterHandler = function(res) {
				if (res.data.payload !== undefined) {
					if (res.data.payload.error == "none") {
						var info = res.data.payload.info;
						this.PlayerHandlers[info.state](this, info);
						this.Ctx.state = info.state;
					}
				}
			}

			function PlayList (api) {
				var self = this;

				this.SongItemComponentHtml = `
					<li class="media" id="id_[ID]">
						<img  class="mr-3" alt="..." style="height: 48px;" id="img_[ID]">
						<div class="media-body">
							<h7 class="mt-0 mb-1">[SONG_NAME]</h7>
							<p><a href="#" onclick="node.Player.SetSong({name:'[SONG_NAME]', id:'[ID]'});node.Player.Play();">Play</a></p>
						</div>
					</li>
					<hr id="id_line_[ID]">
				`;

				return this;
			}
			
			PlayList.prototype.GenerateSongItemView = function(song) {
				var html = this.SongItemComponentHtml;
				html = html.split("[SONG_NAME]").join(song.name);
				html = html.split("[ID]").join(song.id);
				return html;
			}
			
			// Self-genrated area
			var node = new Node();
			node.Init();
			node.Connect();
			var UserGetNodeSensorInfoHandler = function(res) {
				var payload = res.data.payload;
				[RESOURCES]
				// User Code #1 - Start
				var objSongList = document.getElementById("id_song_list");
				for (key in payload.songs) {
					song = payload.songs[key];
					var song_id = CryptoJS.MD5(song).toString();
					var item = {
						name: song,
						id: song_id
					}
					objSongList.innerHTML += node.PlayList.GenerateSongItemView(item);
					node.API.SendCustomCommand(NodeUUID, 'get_resource', { 
																	"id": "img_" + song_id, 
																	"tag": "img", 
																	"src": "resource/img/song.jpeg", 
																	"ui_type": 'config' }, function(res) { 
						var payload = res.data.payload; 
						document.getElementById(payload.id).src = MkSGlobal.ConvertHEXtoString(payload.content); 
					});
					node.Player.SongList.push(item);
				}
				node.Player.SongsCount = node.Player.SongList.length;

				node.Player.RouterHandler(res);
				// User Code #1 - End
				node.API.RegisterOnNodeChange(NodeUUID, function(res) {
					console.log("UI have registered NODE successfuly", res);
				});
			}
			// Self-generated area

			feather.replace();
        </script>
    </body>
</html>
