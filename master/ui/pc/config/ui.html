<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="description" content="">
        <meta name="author" content="">

        <title>TDD Executor</title>

		[CSS]

        <link rel="stylesheet" href="/static/lib/bootstrap/css/bootstrap.min.css" crossorigin="anonymous">
     
        <style>
            body {
              font-size: .875rem;
            }
            .feather {
              width: 16px;
              height: 16px;
              vertical-align: text-bottom;
            }
            html {
              position: relative;
              min-height: 100%;
            }
            body {
              /* Margin bottom by footer height */
              margin-bottom: 60px;
            }
            .footer {
              position: absolute;
              bottom: 0;
              width: 100%;
              /* Set the fixed height of the footer here */
              height: 60px;
              line-height: 60px; /* Vertically center the text there */
              background-color: #f5f5f5;
            }
            body > .container {
              padding: 60px 15px 0;
            }
            .footer > .container {
              padding-right: 15px;
              padding-left: 15px;
            }
            code {
              font-size: 80%;
            }
        </style>

        <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
        <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
        <!--[if lt IE 9]>
          <script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
          <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
        <![endif]-->
    </head>
    <body>
        <main role="main" class="container">
        	<div class="row">
        	    <div class="col-lg-12">
					<div class="accordion" id="accordionExample">
						<div class="card">
							<div class="card-header" id="headingOne">
								<h2 class="mb-0">
									<button class="btn btn-link" type="button" data-toggle="collapse" data-target="#collapseOne" aria-expanded="true" aria-controls="collapseOne">
										Master Public Info
									</button>
								</h2>
							</div>

							<div id="collapseOne" class="collapse show" aria-labelledby="headingOne" data-parent="#accordionExample">
								<div class="card-body">
									<div class="row">
										<div class="col-lg-6">
											<div class="card">
												<div class="card-body">
													<h6 class="d-flex justify-content-between align-items-center mb-3">
														<span class="text-muted">CPU Type</span>
														<span class="text-muted" id="master_cpu_type">n/a</span>
													</h6>
													<h6 class="d-flex justify-content-between align-items-center mb-3">
														<span class="text-muted">CPU Usage</span>
														<span class="text-muted" id="master_cpu_usage">n/a</span>
													</h6>
													<h6 class="d-flex justify-content-between align-items-center mb-3">
														<span class="text-muted">CPU Temperature</span>
														<span class="text-muted" id="master_cpu_temperature">n/a</span>
													</h6>
													<h6 class="d-flex justify-content-between align-items-center mb-3">
														<span class="text-muted">Board Type</span>
														<span class="text-muted" id="master_board_type">n/a</span>
													</h6>
													<h6 class="d-flex justify-content-between align-items-center mb-3">
														<span class="text-muted">OS Type</span>
														<span class="text-muted" id="master_os_type">n/a</span>
													</h6>
												</div>
											</div>
										</div>
										<div class="col-lg-6">
											<div class="card">
												<div class="card-body">
													<div class="card-body">
														<div class="row">
															<div class="col-lg-5">
																<h6 class="d-flex justify-content-between align-items-center mb-3">
																	<span class="text-muted">HD Usage (<a id="master_hd_total">n/a</a>)</span>
																</h6>
															</div>
															<div class="col-lg-7">
																<div class="progress">
																	<div id="master_hd_used" class="progress-bar" role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">0%</div>
																</div>
															</div>
														</div>
														<div class="row">
															<div class="col-lg-5">
																<h6 class="d-flex justify-content-between align-items-center mb-3">
																	<span class="text-muted">RAM Usage (<a id="master_ram_total">n/a</a>)</span>
																</h6>
															</div>
															<div class="col-lg-7">
																<div class="progress">
																	<div id="master_ram_used" class="progress-bar" role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">0%</div>
																</div>
															</div>
														</div>
														<div class="row">
															<div class="col-lg-5">
																<h6 class="d-flex justify-content-between align-items-center mb-3">
																	<span class="text-muted"><a href="#" onclick="node.Machine.Reboot()">Reboot</a></span>
																</h6>
															</div>
														</div>
														<div class="row">
															<div class="col-lg-5">
																<h6 class="d-flex justify-content-between align-items-center mb-3">
																	<span class="text-muted"><a href="#" onclick="OpenModal('install');">Install Node</a></span>
																</h6>
															</div>
														</div>
													</div>
												</div>
											</div>
										</div>
									</div>
								</div>
							</div>
						</div>
						
						<div class="card">
							<div class="card-header" id="headingTwo">
								<h2 class="mb-0">
									<button class="btn btn-link collapsed" type="button" data-toggle="collapse" data-target="#collapseTwo" aria-expanded="false" aria-controls="collapseTwo">
										Network & Connections
									</button>
								</h2>
							</div>
							
							<div id="collapseTwo" class="collapse" aria-labelledby="headingTwo" data-parent="#accordionExample">
								<div class="card-body">
									<div class="row">
										<div class="col-lg-6">
											<div class="card">
												<div class="card-body">
													<h6 class="d-flex justify-content-between align-items-center mb-3">
														<span class="text-muted">Machine Name</span>
														<span class="text-muted" id="master_machine_name">n/a</span>
													</h6>
												</div>
											</div>
											<br>
											<div class="card">
												<div class="card-body">
													<h6 class="d-flex justify-content-between align-items-center mb-3">
														<span class="text-muted"> Network Devices List </span>
														<span class="badge badge-secondary badge-pill" id="network_devices_count_id">0</span>
													</h6>
													<div id="network_devices_list_id"></div>
												</div>
											</div>
										</div>
										<div class="col-lg-6">
											<div class="card">
												<div class="card-body">
													<h6 class="d-flex justify-content-between align-items-center mb-3">
														<span class="text-muted"> Interfaces </span>
														<span class="badge badge-secondary badge-pill" id="network_interfaces_count_id">0</span>
													</h6>
													<div id="network_interfaces_list_id"></div>
												</div>
											</div>
										</div>
									</div>
									<br>
									<h6 class="d-flex justify-content-between align-items-center mb-3">
										<span class="text-muted">Connections List (<a href="#" onclick="node.Machine.GetConnectionsList()">Refresh</a>)</span>
										<span class="badge badge-secondary badge-pill" id="connections_count_id">0</span>
									</h6>
									<div id="connections_list_id"></div>
								</div>
							</div>
						</div>
						
						<div class="card">
							<div class="card-header" id="headingThree">
								<h2 class="mb-0">
									<button class="btn btn-link collapsed" type="button" data-toggle="collapse" data-target="#collapseThree" aria-expanded="false" aria-controls="collapseThree">
										Nodes & Services
									</button>
								</h2>
							</div>
							
							<div id="collapseThree" class="collapse" aria-labelledby="headingThree" data-parent="#accordionExample">
								<div class="card-body">
									<div class="row">
										<div class="col-lg-12">
											<h6 class="d-flex justify-content-between align-items-center mb-3">
												<span class="text-muted">Service List</span>
												<span class="badge badge-secondary badge-pill" id="on_boot_services_count_id">0</span>
											</h6>
											<div id="on_boot_services_list_id"></div>
										</div>
									</div>
									<br/>
									<div class="row">
										<div class="col-lg-12">
											<h6 class="d-flex justify-content-between align-items-center mb-3">
												<span class="text-muted">Nodes List</span>
												<span class="badge badge-secondary badge-pill" id="online_nodes_count_id">0</span>
											</h6>
											<div id="online_nodes_list_id"></div>
										</div>
									</div>
								</div>
							</div>
						</div>						
					</dix>
        	    </div>
        	</div>
		</main>
		
		<!-- Modal -->
		<div class="modal fade bd-example-modal-lg" id="id-gen-modal" tabindex="-1" role="dialog" aria-labelledby="id-gen-modalLabel" aria-hidden="true">
			<div class="modal-dialog modal-lg" role="document">
				<div class="modal-content">
					<div class="modal-header">
						<h5 class="modal-title" id="id-gen-modalLabel">Title</h5>
						<button type="button" class="close" data-dismiss="modal" aria-label="Close">
						<span aria-hidden="true">&times;</span>
						</button>
					</div>
					<div id="id_modal_content" class="modal-body"> </div>
					<div id="id_modal_footer" class="modal-footer"></div>
				</div>
			</div>
		</div>

        <script src="/static/lib/nodes/js/jquery_3_3_1/jquery.min.js"></script>
        <script src="/static/lib/nodes/js/popper_1_14_7/popper.min.js" crossorigin="anonymous"></script>
		<script src="/static/lib/bootstrap/js/bootstrap.min.js" crossorigin="anonymous"></script>
		<script src="/static/lib/bootstrap/js/bootstrap-slider.js" crossorigin="anonymous"></script>
        <script src="/static/lib/nodes/js/feather_4_19/feather.min.js"></script>
        <script src="/static/lib/nodes/map/feather_4_19/feather.min.js.map"></script>
        
        [SCRIPTS]

        <script>
			/*
			[GATEWAY]
			[NODE_UUID]
			[CUSTOM_VARS]
			*/
			var GatewayIP = "[GATEWAY_IP]";
			var NodeUUID  = "[NODE_UUID]";

			console.log("Gateway IP address - " + GatewayIP);

			$(document).ready(function() {
				// User Code #1 - Start
				
				// User Code #1 - End
			});

			function Node() {
				var self = this;

				// Get makesense api instanse.
				this.API 		= MkSAPIBuilder.GetInstance();
				this.Machine 	= new PC(this.API);
				// Update gateway IP address
				this.API.SetGlobalGatewayIP(GatewayIP);
				// Default handler
				this.API.OnUnexpectedDataArrived = function (packet) {
					console.log(packet);
				}

				return this;
			}

			Node.prototype.Init = function() {
				// User Code #1 - Start
				
				// User Code #1 - End
			}

			Node.prototype.OnChangeEvent = function(packet) {
				console.log("OnNodeChangeEvent", this, packet.data.payload.event);
				switch(packet.data.payload.event) {
					case "template": {
					}
					break;
					// User Code #1 - Start
				
					// User Code #1 - End
				}
			}

			Node.prototype.Connect = function() {
				var self = this;
				console.log("Connect Gateway");
				this.API.ConnectGateway(function() {
					console.log("Connection to Gateway was established.");
					self.API.Gateway.OnNodeChangeEvent = self.OnChangeEvent.bind(self);
					self.API.GetNodeInfo(NodeUUID, function(res) {
						UserGetNodeSensorInfoHandler(res);
					});
				});
			}

			function PC(api) {
				self = this;

				this.API 	= api;
				this.UI		= new NodeUI();

				this.MasterPublicInfoIntervakHndl = 0;

				return this;
			}

			PC.prototype.GetConnectionsList = function() {
				self = this;
				this.API.SendCustomCommand(NodeUUID, "get_connections_list", {}, function(res) {
					var payload = res.data.payload;
					document.getElementById("connections_count_id").innerHTML = payload.connections.length;
					var html = `<ul class="list-group mb-3">`;
						payload.connections.forEach(function(element) {
						row = self.UI.ConnectionRow;
						row = row.split("[UUID]").join(element.uuid);
						row = row.split("[LOCAL_TYPE]").join(element.local_type);
						row = row.split("[TYPE]").join(element.type);
						row = row.split("[IP]").join(element.ip);
						row = row.split("[PORT]").join(element.port);
						html = html + row;
					});
				
					html = html + `</ul>`;
					document.getElementById("connections_list_id").innerHTML = html;
					feather.replace();
				});
			}

			PC.prototype.GetInstalledNodesList = function() {
				self = this;
				this.API.SendCustomCommand(NodeUUID, "get_installed_nodes_list", {
				}, function(res) {
					payload = res.data.payload;
					var installed_nodes = payload.installed_nodes;
					document.getElementById("online_nodes_count_id").innerHTML = installed_nodes.length;
					var html = `<div class="card"><div class="card-body">`;
					installed_nodes.forEach(function(element) {
						row = self.UI.InstalledNodeRow;
						row = row.split("[NAME]").join(element.name);
						row = row.split("[UUID]").join(element.uuid);
						row = row.split("[DISABLED]").join("");
						if (element.enabled == 1) {
							row = row.split("[STATE]").join("checked");
						} else {
							row = row.split("[STATE]").join("");
						}
						html = html + row;
					});
				
					html = html + `</div></div>`;
					document.getElementById("online_nodes_list_id").innerHTML = html;
				});
			}

			PC.prototype.GetGitPackages = function() {
				self = this;
				this.API.SendCustomCommand(NodeUUID, "get_git_packages", {
				}, function(res) {
					gGitPackages = res.data.payload.packages;
				});
			}

			PC.prototype.GetMiscInfo = function() {
				self = this;
				this.API.SendCustomCommand(NodeUUID, "get_master_public_info", {
				}, function(res) {					
					payload = res.data.payload;
					document.getElementById("master_cpu_usage").innerHTML = payload.cpu_usage + "%";
					document.getElementById("master_cpu_temperature").innerHTML = payload.cpu_temperature + "C";
					
					document.getElementById("master_ram_total").innerHTML = payload.ram_total + "Mb";
					ramUsage = ((payload.ram_used / payload.ram_total) * 100).toFixed(1)
					document.getElementById("master_ram_used").style.width = ramUsage + "%";
					document.getElementById("master_ram_used").setAttribute("aria-valuenow", ramUsage);
					document.getElementById("master_ram_used").innerHTML = ramUsage + "%";
					
					document.getElementById("master_hd_total").innerHTML = payload.hd_total + "Gb";
					hdUsage = ((payload.hd_used / payload.hd_total) * 100).toFixed(1)
					document.getElementById("master_hd_used").style.width = hdUsage + "%";
					document.getElementById("master_hd_used").setAttribute("aria-valuenow", hdUsage);
					document.getElementById("master_hd_used").innerHTML = hdUsage + "%";
					
					document.getElementById("master_os_type").innerHTML = payload.os_type;
					document.getElementById("master_cpu_type").innerHTML = payload.cpu_type;
					document.getElementById("master_board_type").innerHTML = payload.board_type;
					document.getElementById("master_machine_name").innerHTML = payload.machine_name;
					
					var interfaces = payload.network.interfaces;
					document.getElementById("network_interfaces_count_id").innerHTML = interfaces.length;
					var html = `<div class="card"><div class="card-body">`;
					interfaces.forEach(function(element) {
						row = self.UI.NetworkInterfacesRow;
						row = row.split("[IP]").join(element[0]);
						row = row.split("[MAC]").join(element[1]);
						html = html + row;
					});
					html = html + `</div></div>`;
					document.getElementById("network_interfaces_list_id").innerHTML = html;

					var network_devices = payload.network_devices;
					document.getElementById("network_devices_count_id").innerHTML = network_devices.length;
					var html = `<div class="card"><div class="card-body">`;
					network_devices.forEach(function(element) {
						row = self.UI.NetworkDevicesRow;
						row = row.split("[IP]").join(element.ip);
						if (element.mks !== undefined) {
							row = row.split("[TYPE]").join("MKS (" + element.mks.name + ")");
						} else {
							row = row.split("[TYPE]").join("DEVICE");
						}
						html = html + row;
					});
					html = html + `</div></div>`;
					document.getElementById("network_devices_list_id").innerHTML = html;
					
					feather.replace();
				});
			}

			PC.prototype.GetServicesInfo = function() {
				self = this;
				this.API.SendCustomCommand(NodeUUID, "get_services_info", {
				}, function(res) {
					payload = res.data.payload;
					var on_boot_services = payload.on_boot_services;
					document.getElementById("on_boot_services_count_id").innerHTML = on_boot_services.length;
					var html = `<div class="card"><div class="card-body">`;
					on_boot_services.forEach(function(element) {
						row = self.UI.OnBootServicesRow;
						row = row.split("[NAME]").join(element.name);
						row = row.split("[UUID]").join(element.uuid);
						row = row.split("[DISABLED]").join("");
						if (element.enabled == 1) {
							row = row.split("[STATE]").join("checked");
						} else {
							row = row.split("[STATE]").join("");
						}
						html = html + row;
					});
				
					html = html + `</div></div>`;
					document.getElementById("on_boot_services_list_id").innerHTML = html;
				});
			}

			PC.prototype.UpdateServiceEnable = function(elem, uuid) {
				if (elem.checked) {
					this.API.SendCustomCommand(NodeUUID, "set_service_info", {
						uuid: uuid,
						enabled: 1
					}, function(res) { });
				} else {
					this.API.SendCustomCommand(NodeUUID, "set_service_info", {
						uuid: uuid,
						enabled: 0
					}, function(res) { });
				}
			};

			PC.prototype.UpdateNodeEnable = function(elem, uuid) {
				if (elem.checked) {
					this.API.SendCustomCommand(NodeUUID, "set_installed_node_info", {
						uuid: uuid,
						enabled: 1
					}, function(res) { });
				} else {
					this.API.SendCustomCommand(NodeUUID, "set_installed_node_info", {
						uuid: uuid,
						enabled: 0
					}, function(res) { });
				}
			};

			PC.prototype.Reboot = function() {
				this.API.SendCustomCommand(NodeUUID, "reboot", {
				}, function(res) { });
			}

			var gGitPackages = null;

			var InstallModalContent = `
				<ul class="nav nav-tabs" id="myTab" role="tablist">
					<li class="nav-item waves-effect waves-light">
						<a class="nav-link" id="home-tab" data-toggle="tab" href="#home" role="tab" aria-controls="home" aria-selected="false">File</a>
					</li>
					<li class="nav-item waves-effect waves-light">
						<a class="nav-link active" id="contact-tab" data-toggle="tab" href="#contact" role="tab" aria-controls="contact" aria-selected="true">Git</a>
					</li>
				</ul>
				<div class="tab-content" id="myTabContent">
					<div class="tab-pane fade" id="home" role="tabpanel" aria-labelledby="home-tab">
						<div class="row">
							<div class="col-lg-12">
								<div class="card">
									<div class="card-body">
										<form>
											<div class="form-group">
												<label for="id_package_path">Please select package (ZIP File)</label>
												<input type="file" class="form-control-file" id="id_package_path">
											</div>
										</form>
										<button type="button" id="id_install_button" class="btn btn-primary" onclick="OnInstallClick();">Install</button>
									</div>
								</div>
							</div>
						</div>
					</div>
					<div class="tab-pane fade active show" id="contact" role="tabpanel" aria-labelledby="contact-tab">
						<div class="row">
							<div class="col-lg-12">
								<div class="card">
									<div class="card-body">
										<h6 class="d-flex justify-content-between align-items-center mb-3">
											<span class="text-muted">Nodes List</span>
											<span class="badge badge-secondary badge-pill" id="id_git_packages_count">0</span>
										</h6>
										<div id="id_git_packages"></div>
									</div>
								</div>
							</div>
						</div>
					</div>
				</div>
				<div class="row d-none" id="id_progress">
					<div class="col-lg-12">
						<div class="card">
							<div class="card-body">
								<div class="progress">
									<div id="id_progress_bar" class="progress-bar progress-bar-striped" style="min-width: 20px;"></div>
								</div>
								<div>
									<span class="text-muted" id="id_progress_item">0%</span>
								</div>
							</div>
						</div>
					</div>
				</div>
			`;

			var UninstallModalContent = `
				<div class="row">
					<div class="col-lg-12">
						<span class="text-muted">Do you wish to remove this node?</span>
					</div>
				</div>
				<div class="row d-none" id="id_progress">
					<div class="col-lg-12">
						<div class="card">
							<div class="card-body">
								<div class="progress">
									<div id="id_progress_bar" class="progress-bar progress-bar-striped" style="min-width: 20px;"></div>
								</div>
								<div>
									<span class="text-muted" id="id_progress_item">0%</span>
								</div>
							</div>
						</div>
					</div>
				</div>
			`;

			var InstallModalFooter = `
				<h6 class="d-flex justify-content-between align-items-center mb-3">
					<span class="text-muted"><a href="#" onclick="$('#id-gen-modal').modal('hide');">Close</a></span>
				</h6>
			`;

			var UninstalModalFooter = `
				<button type="button" class="btn btn-primary" onclick="UninstallNode();">Yes</button>
        		<button type="button" class="btn btn-secondary" data-dismiss="modal">No</button>
			`;

			var OpenModal = function (action) {
				switch(action) {
					case "install":
						document.getElementById("id-gen-modalLabel").innerHTML	= "Install Node Package";
						document.getElementById("id_modal_content").innerHTML	= InstallModalContent;
						document.getElementById("id_modal_footer").innerHTML	= InstallModalFooter;
						// Update list of packages
						document.getElementById("id_git_packages_count").innerHTML = gGitPackages.length;
						var html = `<div class="card"><div class="card-body">`;
						gGitPackages.forEach(function(element) {
							row = node.Machine.UI.InstalledGitPackasRow;
							row = row.split("[UUID]").join(element.uuid);
							row = row.split("[TYPE]").join(element.type);
							if (element.installed == 1) {
								row = row.split("[INSTALLED]").join("Installed");
								row = row.split("[SELECT]").join("Select");
							} else {
								row = row.split("[INSTALLED]").join("Not Installed");
								row = row.split("[SELECT]").join("<a href='#' onclick=''>Select</a>");
							}
							html = html + row;
						});
					
						html = html + `</div></div>`;
						document.getElementById("id_git_packages").innerHTML = html;
						break;
					case "uninstall":
						document.getElementById("id-gen-modalLabel").innerHTML	= "Uninstall Node Package";
						document.getElementById("id_modal_content").innerHTML	= UninstallModalContent;
						document.getElementById("id_modal_footer").innerHTML	= UninstalModalFooter;
						break;
					default:
						break;
				}
				
				$('#id-gen-modal').modal('show');
			}

			var fileName = "";
			var fileSize = 0;
			var reader = new FileReader();
			reader.onload = function(e) {
				var data    		= reader.result;
          		var MAX_CHUNK_SIZE  = 4096;
				var buffer  		= new Uint8Array(data);
				var chunks  		= parseInt(fileSize / MAX_CHUNK_SIZE);

				// console.log(buffer, fileSize / MAX_CHUNK_SIZE, chunks);
				if (fileSize % MAX_CHUNK_SIZE != 0) {
					// Append last chunk.
					chunks++;
				}

				start = 0;
				end   = 0;
				percCunck = parseInt(100 / chunks);
				for (i = 0; i < chunks; i++) {
					if ( (fileSize - i * MAX_CHUNK_SIZE) < MAX_CHUNK_SIZE ) {
						// We are at last packet
						start = i * MAX_CHUNK_SIZE;
						end   = fileSize;
					} else {
						start = i * MAX_CHUNK_SIZE;
						end   = start + MAX_CHUNK_SIZE;
					}

					if (start < end) {
						var arrayData = buffer.subarray(start, end);

						var dataToSend = [];
						for (idx = 0; idx < arrayData.length; idx++) {
							dataToSend.push(arrayData[idx]);
						}

						// console.log("send chunk", i+1, start, end, fileSize, dataToSend.length);
						var payload = {
							upload: {
								action: "upload",
								file: fileName,
								size: fileSize,
								content: dataToSend,
								chunk: i+1,
								chunk_size: (end - start),
								chunks: chunks
							}
						}
						// console.log(payload);
						node.API.UploadFileContent(NodeUUID, payload, function(res) {
							if (res) {
								status = res.data.payload.status;
								if (status == "inprogress") {
									console.log("Uploaded " + res.data.payload.chunk + " " + percCunck * res.data.payload.chunk);
									$("#id_progress_bar").css("width", (res.data.payload.chunk * percCunck) + "%").text((res.data.payload.chunk * percCunck) + " %");
									document.getElementById("id_progress_item").innerHTML = "Upload Package";
									document.getElementById("id_install_button").disabled = false;
								} else if (status == "done") {
									$("#id_progress_bar").css("width", "100%").text("100%");
									document.getElementById("id_progress_item").innerHTML = "Unzip Package";
									// Send install command
									node.API.SendCustomCommand(NodeUUID, "install", {
										install: {
											type: "file",
											file: res.data.payload.file
										}
									}, function(res) { 
										status = res.data.payload.status;
										if (status == "done") {
											document.getElementById("id_progress_item").innerHTML = "Installing Package Done";
											$('#id-gen-modal').modal('hide');
										} else if (status == "uuid_exist") {
											document.getElementById("id_progress_item").innerHTML = "Package Allready Installed";
										}
									});
								} else if (status == "timeout") {
									$("#id_progress_bar").css("width", "0%").text("0%");
									document.getElementById("id_progress_item").innerHTML = "Error Upload - Timeout";
								}
							}
						});
					}
				}
			}

			var ReadImage = function(file) {
				// Check if the file is zip file.
				if (file.type && file.type.indexOf('zip') === -1) {
					console.log('File is not an image.', file.type, file);
					return;
				}

				fileName = file.name;
				fileSize = file.size;
				reader.readAsArrayBuffer(file);
			}

			var OnInstallClick = function() {
				var fileObj = document.getElementById("id_package_path");
				// Show progress bar
				document.getElementById("id_progress").classList.remove("d-none");
				ReadImage(fileObj.files[0]);
			}

			var InstallGitPackage = function(type) {
				document.getElementById("id_progress").classList.remove("d-none");
				$("#id_progress_bar").css("width", "10%").text("10%");
				document.getElementById("id_progress_item").innerHTML = "Installing Package";
				node.API.SendCustomCommand(NodeUUID, "install", {
					install: {
						type: "git",
						file: type
					}
				}, function(res) { 
					status = res.data.payload.status;
					if (status == "done") {
						$("#id_progress_bar").css("width", "100%").text("100%");
						document.getElementById("id_progress_item").innerHTML = "Installing Package Done";
						$('#id-gen-modal').modal('hide');
					}
				});
			}

			var gUninstallNodeUUID = "";
			var UninstallNode = function() {
				node.API.SendCustomCommand(NodeUUID, "uninstall", {
					uninstall: {
						uuid: gUninstallNodeUUID
					}
				}, function(res) { 
					status = res.data.payload.status;
					if (status == "done") {
						$('#id-gen-modal').modal('hide');
					}
				});
			}

			var OnUninstallClick = function(uuid) {
				gUninstallNodeUUID = uuid;
				OpenModal("uninstall");
			}

			function NodeUI (api) {
				self = this;

				this.TestRow = `
					<li class="list-group-item d-flex justify-content-between lh-condensed">
						<div><h6 class="my-0">[TEST_NAME]</h6></div>
						<div>
							<span onClick="PlayTest('[TEST_NAME]');" style="width: 18px; height: 18px; cursor: pointer;color: green" data-feather="play-circle"></span>
							<span onClick="GetTestOutput('[TEST_NAME]');" style="width: 18px; height: 18px; cursor: pointer;" data-feather="file-text"></span>
							<span id="[TEST_NAME]_id" style="width: 18px; height: 18px; color: red" data-feather="x-square"></span>
						</div>
					</li>
				`;
				this.ConnectionRow = `
					<li class="list-group-item d-flex justify-content-between lh-condensed">
						<div><small class="my-0">[UUID]</small></div>
						<div><small class="my-0">[LOCAL_TYPE]</small></div>
						<div><small class="my-0">[TYPE]</small></div>
						<div><small class="my-0">[IP]</small></div>
						<div><small class="my-0">[PORT]</small></div>
						<div><span onClick="" style="width: 16px; height: 16px; cursor: pointer;color: green" data-feather="settings"></span></div>
					</li>
				`;
				this.NetworkInterfacesRow = `
					<li class="list-group-item d-flex justify-content-between lh-condensed">
						<div><small class="my-0">[IP]</small></div>
						<div><small class="my-0">[MAC]</small></div>
						<div><span onClick="" style="width: 16px; height: 16px; cursor: pointer;color: green" data-feather="settings"></span></div>
					</li>
				`;
				this.NetworkDevicesRow = `
					<li class="list-group-item d-flex justify-content-between lh-condensed">
						<div><small class="my-0">[IP]</small></div>
						<div><small class="my-0">[TYPE]</small></div>
						<div><span onClick="" style="width: 16px; height: 16px; cursor: pointer;color: green" data-feather="settings"></span></div>
					</li>
				`;
				this.OnBootServicesRow = `
					<li class="list-group-item d-flex justify-content-between lh-condensed">
						<div><small class="my-0">[NAME]</small></div>
						<div><small class="my-0">[UUID]</small></div>
						<div>
							<div class="custom-control custom-switch">
								<input type="checkbox" class="custom-control-input" [DISABLED] [STATE] onchange="node.Machine.UpdateServiceEnable(this, '[UUID]')" id="switch_id_[UUID]">
								<label class="custom-control-label" for="switch_id_[UUID]"></label>
							</div>
						</div>
					</li><br/>
				`;
				this.InstalledNodeRow = `
					<li class="list-group-item d-flex justify-content-between lh-condensed">
						<div><small class="my-0">[NAME]</small></div>
						<div><small class="my-0">[UUID]</small></div>
						<div class="custom-control custom-switch">
							<input type="checkbox" class="custom-control-input" [DISABLED] [STATE] onchange="node.Machine.UpdateNodeEnable(this, '[UUID]')" id="switch_id_[UUID]">
							<label class="custom-control-label" for="switch_id_[UUID]"></label>
						</div>
						<div><span onClick="OnUninstallClick('[UUID]')" style="width: 16px; height: 16px; cursor: pointer;color: red" data-feather="trash-2"></span></div>
					</li><br/>
				`;
				this.InstalledGitPackasRow = `
					<li class="list-group-item d-flex justify-content-between lh-condensed">
						<div><small class="my-0">[UUID]</small></div>
						<div><small class="my-0">[TYPE]</small></div>
						<div><small class="my-0">[INSTALLED]</small></div>
						<div>
							<h6 class="d-flex justify-content-between align-items-center mb-3">
							<span class="text-muted" onClick="InstallGitPackage('[TYPE]')">[SELECT]</span>
							</h6>
						</div>
					</li><br/>
				`;

				return this;
			}
  
			// Self-genrated area
			var node = new Node();
			node.Init();
			node.Connect();
			var UserGetNodeSensorInfoHandler = function(res) {
				var payload = res.data.payload;
				// User Code #1 - Start
				node.Machine.GetConnectionsList();
				node.Machine.GetMiscInfo();
				node.Machine.MasterPublicInfoIntervakHndl = setInterval(node.Machine.GetMiscInfo.bind(node.Machine), 5000);
				node.Machine.GetServicesInfo();
				node.Machine.GetInstalledNodesList();
				node.Machine.GetGitPackages();
				// User Code #1 - End
				node.API.RegisterOnNodeChange(NodeUUID, function(res) {
					console.log("UI have registered NODE successfuly", res);
				});
			}
			// Self-generated area
          
        </script>
    </body>
</html>
