<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="description" content="">
        <meta name="author" content="">

        <title>USB Cameras</title>

		[CSS]

		<link rel="stylesheet" href="/static/lib/bootstrap/css/bootstrap.min.css" crossorigin="anonymous">
		<link rel="stylesheet" href="/static/lib/bootstrap/css/bootstrap-slider.css" crossorigin="anonymous">
		<link rel="stylesheet" href="/static/lib/fontawesome-5.11.2/css/all.min.css">
		<link rel="stylesheet" href="/static/lib/bootstrap4-editable/css/bootstrap-editable.css">
		<link rel="stylesheet" href="/static/lib/chartjs/2.9.3/Chart.min.css">
		<link rel="stylesheet" href="/static/lib/datetimepicker/bootstrap-datetimepicker.min.css">
     
        <style>
            body {
              font-size: .875rem;
            }
            .feather {
              width: 16px;
              height: 16px;
              vertical-align: text-bottom;
            }
            html {
              position: relative;
              min-height: 100%;
            }
            body {
              /* Margin bottom by footer height */
              margin-bottom: 60px;
            }
            .footer {
              position: absolute;
              bottom: 0;
              width: 100%;
              /* Set the fixed height of the footer here */
              height: 60px;
              line-height: 60px; /* Vertically center the text there */
              background-color: #f5f5f5;
            }
            body > .container {
              padding: 60px 15px 0;
            }
            .footer > .container {
              padding-right: 15px;
              padding-left: 15px;
            }
            code {
              font-size: 80%;
            }
        </style>

        <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
        <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
        <!--[if lt IE 9]>
          <script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
          <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
        <![endif]-->
    </head>
	<body style="background-color: #f5f5f5;">
		<main role="main" class="container">
			<br><br>
			<div class="row">
				<div class="col-lg-2"></div>
        	    <div class="col-lg-8">
        	        <div class="card">
						<div class="card-body">
							<ul class="list-unstyled" id="id_camera_list">
							</ul>
						</div>
					</div>
				</div>
			</div>
		</main>

		<script src="/static/lib/nodes/js/jquery_3_3_1/jquery.min.js"></script>
		<script src="/static/lib/nodes/js/popper_1_14_7/popper.min.js" crossorigin="anonymous"></script>
		<script src="/static/lib/bootstrap/js/bootstrap.min.js" crossorigin="anonymous"></script>
		<script src="/static/lib/bootstrap/js/bootstrap-slider.js" crossorigin="anonymous"></script>
		<script src="/static/lib/nodes/js/feather_4_19/feather.min.js"></script>
		<script src="/static/lib/nodes/map/feather_4_19/feather.min.js.map"></script>
		<script src="/static/lib/bootstrap4-editable/js/bootstrap-editable.min.js"></script>
		<script src="/static/lib/datetimepicker/bootstrap-datetimepicker.min.js"></script>
		<script src="/mksdk-js/widgets/basic_modal.js"></script>

		[SCRIPTS]

        <script>
			[CONFIGURATION]
			  
			console.log("Gateway IP address - " + GatewayIP);

			$(document).ready(function() {
				// User Code #1 - Start
				
				// User Code #1 - End
			});

			function Node() {
				var self = this;

				// Get makesense api instanse.
				this.API = MkSAPIBuilder.GetInstance();
				// Update gateway IP address
				this.API.SetGlobalGatewayIP(GatewayIP);
				this.API.SetLocalWebsockIP(LocalWSIP);
				this.API.SetLocalWebsockPort(LocalWSPORT);
				// Default handler
				this.API.OnUnexpectedDataArrived = function (packet) {
					console.log(packet);
				}

				// User Code #1 - Start
				this.Cameras = new CameraManager(this.API)
				// User Code #1 - End

				return this;
			}

			// Self-genrated area
			Node.prototype.Init = function() {
			}
			// Self-genrated area

			// Self-genrated area
			Node.prototype.OnChangeEvent = function(packet) {
				console.log("OnNodeChangeEvent", packet.data.payload.event);
				data = packet.data.payload.data;
				switch(packet.data.payload.event) {
					// User Code #1 - Start
					case "on_camera_connected":
						console.log(data);
					break;
					case "on_frame_change": {
						// Set frame
						var imgObj = document.getElementById("id_frame_" + data.meta.uid);
						imgObj.src = "data:image/jpg;base64," + data.frame;
						// Set FPS
						document.getElementById("id_camera_fps").innerHTML = data.meta.fps;
						// Set sensetivity slider
						$('#id_sensetivity').slider('setValue', data.meta.sensetivity);
						document.getElementById("id_sensetivity_value").innerHTML = data.meta.sensetivity;
						// Set FPS slider
						$('#id_fps').slider('setValue', Math.round(data.meta.user_fps));
						document.getElementById("id_fps_value").innerHTML = Math.round(data.meta.user_fps);
					}
					break;				
					// User Code #1 - End
					default:
					break;
				}
			}
			// Self-genrated area

			// Self-genrated area
			Node.prototype.Connect = function() {
				var self = this;
				console.log("Connect Gateway");
				self.API.OnNodeChangeCallback = self.OnChangeEvent.bind(self);
				this.API.ConnectGateway(function() {
					console.log("Connection to Gateway was established.");
					self.API.GetNodeSensorsInfo(NodeUUID, function(res) {
						UserGetNodeSensorInfoHandler(res);
					});
				});
			}
			// Self-genrated area

			// Self-genrated area
			var node = new Node();
			node.Init();
			node.Connect();
			var UserGetNodeSensorInfoHandler = function(res) {
				var payload = res.data.payload;
				[RESOURCES]
				node.API.ConnectLocalWS(NodeUUID, function(res) {
					console.log("Connected to local websocket", res);
				});
				// User Code #1 - Start
				var objCameraList = document.getElementById("id_camera_list");
				for (idx = 0; idx < payload.cameras.length; idx++) {
					camera = payload.cameras[idx];
					objCameraList.innerHTML += node.Cameras.GenerateRowItemView(camera);
					node.API.SendCustomCommand(NodeUUID, 'get_resource', { 
																	"id": "img_" + camera.uid, 
																	"tag": "img", 
																	"src": "resource/img/camera.png", 
																	"ui_type": 'app' }, function(res) { 
						var payload = res.data.payload;
						console.log("RESOURCE", payload);
						document.getElementById(payload.id).src = MkSGlobal.ConvertHEXtoString(payload.content); 
					});
				}
				// User Code #1 - End
				node.API.RegisterOnNodeChange(NodeUUID, function(res) {
					console.log("UI have registered NODE successfuly", res);
				});
			}
			// Self-generated area

			// User Code #1 - Start
			function CameraManager(api) {
				var self = this;
				this.API = api;

				this.Modal = new MksBasicModal();
				this.Modal.SetTitle("Camer Information");

				this.RowItemComponentHtml = `
					<li class="media" id="id_[UID]">
						<img  class="mr-3" alt="..." style="height: 48px;" id="img_[UID]">
						<div class="media-body">
							<h7 class="mt-0 mb-1">[NAME]</h7>
							<p><a href="#" onclick="node.Cameras.OpenCameraInformation({name:'[NAME]', uid:'[UID]', path:'[PATH]'});">Open</a></p>
						</div>
					</li>
					<hr id="id_line_[ID]">
				`;

				this.CameraInformationContainer = `
					<br>
					<div class="row">
						<div class="col-lg-12">
							<img style="width:100%; height:100%" class="rounded" id="id_frame_[UID]"/>
						</div>
					</div>
					<br>
					<div class="row">
						<div class="col-lg-6">
							<div class="card">
								<div class="card-body">
									<h7 class="d-flex justify-content-between align-items-center mb-3">
										<span class="text-muted">Name</span>
										<a href="#" id="id_camera_name">[NAME]</a>
									</h7>
									<h7 class="d-flex justify-content-between align-items-center mb-3">
										<span class="text-muted">UID</span>
										<span class="text-muted" id="id_camera_uid">[UID]</span>
									</h7>
									<h7 class="d-flex justify-content-between align-items-center mb-3">
										<span class="text-muted">Device Path</span>
										<span class="text-muted" id="id_camera_dev_path">[PATH]</span>
									</h7>
									<h7 class="d-flex justify-content-between align-items-center mb-3">
										<span class="text-muted">FPS</span>
										<span class="text-muted" id="id_camera_fps">0 fps</span>
									</h7>
								</div>
							</div>
						</div>
						<div class="col-lg-6">
							<div class="card">
								<div class="card-body">
									<h6 class="d-flex justify-content-between align-items-center mb-3">
										<span class="text-muted">Sensetivity</span>
										<span class="badge badge-secondary badge-pill" id="id_sensetivity_value">0</span>
									</h6>
									<input style="width: 100%" type="text" data-slider-min="70" data-slider-max="100" data-slider-step="1" id="id_sensetivity">
								</div>
								<div class="card-body">
									<h6 class="d-flex justify-content-between align-items-center mb-3">
										<span class="text-muted">Frame Per Second</span>
										<span class="badge badge-secondary badge-pill" id="id_fps_value">0</span>
									</h6>
									<input style="width: 100%" type="text" data-slider-min="1" data-slider-max="5" data-slider-step="1" id="id_fps">
								</div>
							</div>
						</div>
					</div>
				`;

				return this;
			}

			CameraManager.prototype.GenerateRowItemView = function(data) {
				var html = this.RowItemComponentHtml;
				html = html.split("[NAME]").join(data.name);
				html = html.split("[UID]").join(data.uid);
				html = html.split("[PATH]").join(data.path);
				return html;
			}

			CameraManager.prototype.OpenCameraInformation = function(data) {
				var html = this.CameraInformationContainer;
				html = html.split("[NAME]").join(data.name);
				html = html.split("[UID]").join(data.uid);
				html = html.split("[PATH]").join(data.path);

				this.Modal.SetContent(html);
				this.Modal.Build("lg");
				this.Modal.Show();

				// Init sensitivity slider
				$('#id_sensetivity').slider({
					value : 0,
					formatter: function(value) {
						return 'Current value: ' + value;
					}
				});
				$('#id_sensetivity').slider().on('slide', function(ev) {
					document.getElementById("id_sensetivity_value").innerHTML = ev.value;
					node.API.SendCustomCommand(NodeUUID, "options", {
						option: "set_sensetivity",
						uid: data.uid,
						value: ev.value
					}, function(res) {
						console.log(res.data.payload)
					});
				});
				// Init fps slider
				$('#id_fps').slider({
					value : 0,
					formatter: function(value) {
						return 'Current value: ' + value;
					}
				});
				$('#id_fps').slider().on('slide', function(ev) {
					document.getElementById("id_fps_value").innerHTML = ev.value;
					node.API.SendCustomCommand(NodeUUID, "options", {
						option: "set_fps",
						uid: data.uid,
						value: ev.value
					}, function(res) {
						console.log(res.data.payload)
					});
				})
			}
			// User Code #1 - End

			feather.replace();
        </script>
    </body>
</html>